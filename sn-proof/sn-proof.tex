\documentclass{article}
\usepackage{lmodern}%
\usepackage{enumitem}
\usepackage[authoryear]{natbib}

\newtheorem{exercise}{Exercise}[section]
% \newenvironment{exercise}{\begin{@exercise}\rm}{\end{@exercise}}
\newenvironment{ADDITIONAL}[1]{#1}{}
\newenvironment{SOLUTION}[1]{\paragraph*{Solution}\begin{it}#1}{\end{it}}

%\oddsidemargin 0pt
%\evensidemargin \oddsidemargin
%\marginparwidth 0.5in



% \setlength{\topmargin}{15mm}
\setlength{\topmargin}{5mm}

%\setlength{\textwidth}{155mm}
\setlength{\textwidth}{155mm}
%\setlength{\textwidth}{165mm}
\setlength{\textheight}{200mm}
%\setlength{\textheight}{195mm}

\setlength{\evensidemargin}{5mm}
\setlength{\oddsidemargin}{5mm}

\newcommand{\hs}[1]{\hspace{#1}}

% \usepackage{fullpage}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{latexsym}
\usepackage{amsfonts}
\usepackage{listings}
\usepackage{srcltx}
\usepackage{charter}
\usepackage{euler}

\usepackage{latexsym}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{comment}

\ifdefined\studentversion
  \excludecomment{exercise}
  \excludecomment{solution}
  \excludecomment{additional}
\else
% \excludecomment{additional}
\includecomment{exercise}
\includecomment{solution}
\includecomment{additional}
\fi

\newtheorem{@problem}{Exercise}[section]
\newenvironment{problem}{\begin{@problem}\rm}{\end{@problem}}

\newtheorem{@sol}{Solution}[section]
\newenvironment{sol}{\begin{@sol}\rm}{\end{@sol}}

\newcommand{\ext}[1]{\geq_{#1}}

\usepackage{proof}
\usepackage{cdsty}

\newcommand{\nl}{\overline{n}}

\newtheorem{@axiom}{Axiom}
\newenvironment{axiom}{\begin{@axiom}\rm}{\end{@axiom}}
% \newtheorem{@theorem}{Theorem}[section]
% \newenvironment{theorem}{\begin{@theorem}\rm}{\end{@theorem}}

 \newtheorem*{@lemma-nonum}{Lemma}
 \newenvironment{lemma*}{\begin{@lemma-nonum}\rm}{\end{@lemma-nonum}}

 \newtheorem*{@thm-nonum}{Theorem}
 \newenvironment{theorem*}{\begin{@thm-nonum}\rm}{\end{@thm-nonum}}



\input prelude

\usepackage{graphics}
\usepackage{graphicx}

\usepackage{lstextract}

% \includeonly{intro,assign,unif,memo,index,memo-implement,proving}
% \includeonly{index}

\newcommand{\B}{\mathcal{B}}
\newcommand{\C}{\mathcal{C}}
\newcommand{\G}{\mathcal{G}}
\renewcommand{\H}{\mathcal{H}}
\renewcommand{\P}{\mathcal{P}}
\newcommand{\Q}{\mathcal{Q}}

\newcommand{\nf}[2]{#1 : #2 ~\mathsf{nf}}
\newcommand{\neu}[2]{#1 : #2 ~\mathsf{ne}}

 \newcommand{\one}{1}
\newcommand{\SN}{\mathsf{SN}}
\newcommand{\SNe}{\mathsf{SNe}}
\newcommand{\csn}{\mathsf{sn}}
\newcommand{\CR}{\textsf{CR}}
\newcommand{\denot}[1]{\mathcal{R}_{#1}}
\newcommand{\inden}[3]{#1 \vdash #2 \in \denot{#3}}
\newcommand{\mred}{\longrightarrow^*}
\newcommand{\red}{\longrightarrow}
\newcommand{\redsn}{\longrightarrow_\csn}
\newcommand{\redSN}{\longrightarrow_\SN}
\newcommand{\clos}[1]{\overline{#1}}
\newcommand{\imply}{\Longrightarrow}
\renewcommand{\vec}[1]{\overrightarrow #1}

\newcommand{\id}{\textsf{wk}}
\newcommand{\wk}{\textsf{wk}}

\def\lv{\mathopen{{[\kern-0.14em[}}}    % opening [[ value delimiter
\def\rv{\mathclose{{]\kern-0.14em]}}}   % closing ]] value delimiter
\newcommand{\A}{\mathcal{A}}
% \newcommand{\G}{\mathcal{G}}
\newcommand{\den}[1]{\lv #1 \rv}
\newcommand{\Den}[3][]{\den{#2}^{#1}_{#3}}
\newcommand{\dent}[2]{\llparenthesis#1\rrparenthesis_{#2}}


\long\def\ednote#1{\footnote{[{\it #1\/}]}\message{ednote!}}
% \long\def\note#1{\begin{quote}[{\it #1\/}]\end{quote}\message{note!}}

\begin{document}
\title{POPLMark Reloaded Benchmark: An Introduction \\
-- Work in Progress --}
\author{%
Brigitte Pientka \\ McGill University%
  \and Aliya Hameer \\ McGill University%
  \and Alberto Momigliano \\ University of Milan%
  \and Andreas Abel \\ Chalmers %
%
  }
\date{}
\maketitle

We discuss here an alternative proof method for proving
normalization. We will focus here on a \emph{semantic} proof method
using \emph{saturated sets} (see \cite{Luo:PHD90}). This proof method
goes back to \cite{Girard1972} building on some previous ideas
by \cite{Tait67}.

The key question is how to prove that given a lambda-term, its
evaluation terminates, i.e. normalizes. We concentrate here on a typed
operational semantics following \cite{Goguen:TLCA95} and define
a reduction strategy that transforms $\lambda$-terms into
$\beta$ normal form. This allows us to give a concise presentation of the important issues that arise.

 We see this benchmark as a good jumping point to investigate and mechanize the meta-theory of dependently typed systems where a typed operational semantics simplifies the study of its meta-theory. The approach of typed operational semantics is however not limited to dependently typed systems, but it has been used extensively in studying subtyping,  type-preserving compilation, and shape analysis. Hence, we believe it does describe an important approach to describing reductions.



\section{Simply Typed Lambda Calculus with Type-directed Reduction}
Recall the lambda-calculus together with its reduction rules.


\[
\begin{array}{llcl}
\mbox{Terms}  & M,N & \bnfas & x \mid \lambda x{:A}. M \mid M\;N \\
\mbox{Types} & A, B & \bnfas & \base \mid A \arrow B
\end{array}
\]

We consider as the main rule for reduction (or evaluation) applying a term to an abstraction, called \emph{$\beta$-reduction}.
% together with \emph{$\eta$-expansion}. We only $\eta$-expand a term, if we do not immediately create a redex to avoid infinite alternations between $\eta$-expansion and $\beta$-reduction.
 We use the judgment $\Gamma \vdash M \red N :A$ to mean that both $M$ and $N$ have type $A$ in the context $\Gamma$ and the term $M$ reduces to the term $N$.

% \[
% \begin{array}{lcll}
% %\multicolumn{3}{l}{\mbox{$\beta$-reduction}}  \\
% \Gamma \vdash (\lambda x{:}A.M)\;N : B & \red & \Gamma \vdash [N/x]M : B & \mbox{$\beta$-reduction} \\
% \Gamma \vdash M : A \arrow B & \red & \Gamma \vdash \lambda x{:}A.M~x : A \arrow B & \mbox{$\eta$-expansion}
% \end{array}
% \]

% The $\beta$-reduction rule only applies once we have found a redex.  However, we also need congruence rules to allow evaluation of arbitrary subterms.

\[
\begin{array}{c}
\infer[\beta]
{\Gamma \vdash (\lambda x{:}A.M)~N  \red [N/x]M : B }
%    {\Gamma \vdash \lambda x{:}A.M : A \arrow B & \Gamma \vdash  N : A}
    {\Gamma, x{:}A \vdash M :  B & \Gamma \vdash  N : A}
\qquad
%\infer[\eta]{\Gamma \vdash M \red \lambda x{:}A.M~x : A \arrow B}{
% M \not= \lambda y{:}A.M'}
\\[1em]
\infer{\Gamma \vdash M\,N \red M'\,N : B}{\Gamma \vdash M \red M' : A \arrow B & \Gamma \vdash N : A}
\qquad
\infer{\Gamma \vdash M\,N \red M\,N' : B}{\Gamma \vdash M : A \arrow B & \Gamma \vdash N \red N' : A}
\\[1em]
\infer{\Gamma \vdash \lambda x{:}A.M \red \lambda x{:}A.M' : A \arrow B}{\Gamma, x{:}A \vdash M \red M' : B}
\end{array}
\]

Our typed reduction relation is inspired by the type-directed
definition of algorithmic equality for $\lambda$-terms (see for
example \cite{Crary:ATAPL} or \cite{Harper03tocl}). Keeping track of
types in the definition of equality or reduction becomes quickly
necessary as soon as want to add $\eta$-expansion or add a unit type
where every term of type unit reduces to the unit element. We will
consider the extension with the unit type in Section~\ref{sec:unit}.


On top of the single step reduction relation, we can define multi-step
reductions as usual:

\[
\ianc{}{\Gamma \vdash M \mred N : B}{\Gamma \vdash M \red N} \qquad
\ibnc{\Gamma \vdash M \red N : B}{\Gamma \vdash N \mred M' : B}
      {\Gamma \vdash M \mred M' : B}{}
\]

Our definition of multi-step reductions guarantees that we take at least one step.
In addition, we have that typed reductions are only defined on well-typed terms, i.e. if $M$ steps then $M$ is well-typed.

\begin{lemma}[Basic Properties  of Typed Reductions and Typing]\quad
  \begin{itemize}
  \item If $\Gamma \vdash M \red N : A$ then $\Gamma \vdash M : A$ and $\Gamma \vdash N : A$.
  \item If $\Gamma \vdash M : A$ then $A$ is unique.
  \end{itemize}
\end{lemma}


The typing and typed reduction strategy satisfies weakening and
strengthening\ednote{Should maybe be already formulated using context
  extensions? -bp. Likewise, the subsitution lemma cound be formulated with well typed subst. Moreover the weaken/stren of typing follow from the same for reduction and lemma 1.1 -am}.

\begin{lemma}[Weakening and Strengthening of Typing and Typed Reductions]\label{lem:redprop}\quad
  \begin{itemize}
  \item If $\Gamma, \Gamma' \vdash M : B$ then $\Gamma, x{:}A, \Gamma' \vdash M : B$.
  \item If $\Gamma, x{:}A, \Gamma' \vdash M : B$ and $x \not\in\FV(M)$ then $\Gamma, \Gamma' \vdash M : B$.
  \item If $\Gamma, \Gamma' \vdash M \red N : B$ then $\Gamma, x{:}A, \Gamma' \vdash M \red N : B$.
  \item If $\Gamma, x{:}A, \Gamma' \vdash M \red N : B$ and $x \not\in \FV(M)$ then
        $x \not\in \FV N$ and $\Gamma, \Gamma' \vdash M \red N : B$.
  \end{itemize}
\end{lemma}
\begin{proof}
By induction on the first derivation.
\end{proof}


\begin{lemma}[Substitution Property of Typed Reductions]\label{lem:redsubst}\quad
If $\Gamma, x{:}A \vdash M \red M' : B$ and $\Gamma \vdash N : A$ then 
$\Gamma \vdash [N/x]M \red [N/x]M' : B$.
\end{lemma}
\begin{proof}
By induction on the first derivation, unsing standard properties of composition of substitutions. 
\end{proof}


We also will rely on some standard multi-step reduction properties which are proven by induction\ednote{There are some typing assumptions missing, I think, eg $N : A$ in 2 etc. 5 can be generalized to well typed subst again -am}.

\begin{lemma}[Properties of Multi-Step Reductions]\label{lm:mredprop}
\quad
\begin{enumerate}
\item\label{lm:mredtrans} If $\Gamma \vdash M_1 \mred M_2 : B$ and $\Gamma \vdash M_2 \mred M_3 : B$ then $\Gamma \vdash M_1 \mred M_3 : B$.
\item\label{lm:mredappl} If $\Gamma \vdash M \mred M' : A \arrow B$ then $\Gamma \vdash M~N \mred M'~N : B$.
\item\label{lm:mredappr} If $\Gamma \vdash N \mred N' : A$ then $\Gamma \vdash M~N \mred M~N' : B$.
\item\label{lm:mredabs} If $\Gamma,x{:}A \vdash M \mred M' : B$ then $\Gamma \vdash \lambda x{:}A.M \mred \lambda x{:}A.M : A \arrow B$.
\item\label{lm:mredsubs} If $\Gamma, x{:}A \vdash M : B$ and $\Gamma \vdash N \red N' : A$
then $ \Gamma \vdash [N/x]M \mred [N'/x]M : B$.
\end{enumerate}  
\end{lemma}



\subsection*{When is a term in normal form?}

We define here briefly when a term is in $\beta$-normal form.
% The presence of $\eta$ again requires our definition to be type directed.
We define the grammar of normal terms as given below

\[
\begin{array}{llcl}
\mbox{Normal Terms}  & M,N & \bnfas & \lambda x{:A}. M \mid R \\
\mbox{Neutral Terms} & R, P & \bnfas & x \mid R\;M \\
  \end{array}
\]

This grammar does not enforce $\eta$-long.
% For example, $\lambda x{:}A \arrow A. x$ is not in $\eta$-long form.
% To ensure we only characterize $\eta$-long forms, we must ensure that we allow to switch between normal and neutral types at base type.  % On the other hand, $\lambda x{:}A \arrow A. \lambda y{:}A.x~y$ is in $\beta$-short and $\eta$-long form.

% \[
%   \begin{array}{c}
% \multicolumn{1}{l}{\fbox{$\nf {\Gamma \vdash M} A$}~~\mbox{Term $M$ is normal at type $A$}}\\[1em]
% \ianc{\nf {\Gamma, x{:}A \vdash M} B}
%      {\nf {\Gamma \vdash \lambda x{:}A.M} {A \arrow B}}{} \quad
% \ianc{\neu {\Gamma \vdash R}{\base}}
%      {\nf {\Gamma \vdash R}{\base}}{}
% \\[1em]
% \multicolumn{1}{l}{\fbox{$\neu {\Gamma \vdash M} A$}~~\mbox{Term $M$ is neutral at type $A$}}\\[1em]
% \ibnc{\neu {\Gamma \vdash R} {A \arrow B}}{\nf {\Gamma \vdash M} A}
%      {\neu {\Gamma \vdash R~M} {B}}{}
% \qquad
% \ianc{x{:}A \in \Gamma}{\neu {\Gamma \vdash x} {A}}{}
%   \end{array}
% \]

% In practice, it often suffices to enforce that we reduce a term to a weak head normal form. For weak head normal forms we simply remove the requirement that all terms applied to a neutral term must be normal.




\subsection*{Proving normalization}
The question then is, how do we know that we can normalizing a well-typed lambda-term into its $\beta$ normal form? - This is equivalent to asking whether after some reduction steps we will end up in a normal form where there are no further reductions possible. Since a normal lambda-term characterizes normal proofs, normalizing a lambda-term corresponds to normalizing proofs and demonstrates that every proof in the natural deduction system indeed has a normal proof. %

Proving that reduction must terminate is not a simple syntactic argument based on terms, since the $\beta$-reduction rule may yield a term which is bigger than the term we started with. % Further, $\eta$-expansion might make the term bigger.

As syntactic arguments are not sufficient to argue that we can always compute a $\beta$ normal form, we hence need to find a different inductive argument. For the simply-typed lambda-calculus, we could prove that while the expression itself does not get smaller,  the type of an expression does\footnote{This is the essential idea of hereditary substitutions \cite{Watkins02tr}}.  This is a syntactic argument; it however does not scale to polymorphic lambda-calculus or full dependent type theories. We will here instead discuss a \emph{semantic} proof method where we define the meaning of well-typed terms using the abstract notion of \emph{reducibility candidates}.

Throughout this tutorial, we stick to the simply typed lambda-calculus and its extension. This allows us to give a concise presentation of the important issues that arise.  However the most important benefits of typed operational semantics and our approach are demonstrated in systems with dependent types  where our development of the metatheoretic simpler than the existing techniques. We see this benchmark hence as a good jumping point to investigate and mechanize the meta-theory of dependently typed systems.


% Unlike all the previous proofs which were syntactic and direct based on the structure of the derivation or terms, semantic proofs

\section{Semantic Interpretation}
Working with well-typed terms means we need to be more careful to
consider a term within its typing context. In particular, when we
define the semantic interpretation of $\inden{\Gamma}{M}{A \arrow B}$
we must consider all extensions of $\Gamma$ (described by $\Gamma'
\ext \rho \Gamma$) in which we may use $M$.

\begin{itemize}
\item $\inden{\Gamma}{M}{\base}$ iff $\Gamma \vdash M\hastype \base$ and $M$ is strongly normalizing
% , i.e. $\Gamma \vdash M \in \SN$.
\item $\inden{\Gamma}{M}{A \arrow B}$ iff for all $\Gamma' \ext{\rho} \Gamma$ and $\Gamma' \vdash N :A$, if $\inden{\Gamma'}{N}{A}$ then $\inden{\Gamma'}{[\rho]M~N}{B}$.
\end{itemize}


% Weakening holds for the semantic interpretations.

% \begin{lemma}[Semantic Weakening]\ref{lm:sweak}
% If $\Gamma \models M : A$ then $\Gamma, x{:}C \models M : A$.
% \end{lemma}

% We sometimes write these definitions more compactly as follows

% \[
% \begin{array}{llcl}
% \mbox{Semantic base type} & \den{o} & := & \SN  \\
% \mbox{Semantic function type} & \den{A \arrow B} & := & \{ M | \forall \Gamma' \ext{\rho} \Gamma,~\forall \Gamma' \vdash N : A.~ \Gamma'\ models N : A \ \in \den{A}. M\;N \in \den{B} \}
% \end{array}
% \]


\section{General idea}

We prove that if a term is well-typed, then it is strongly normalizing in  two steps:

\begin{description}
\item[Step 1] If $\inden{\Gamma}{M}{A}$ then $\Gamma \vdash M : A$ and $M$ is strongly normalizing.
\item[Step 2] If $\Gamma \vdash M : A$ and $\inden{\Gamma'}{\sigma}{\Gamma}$ then $\inden{\Gamma'}{[\sigma]M}{A}$.
\end{description}

Therefore, we can conclude that if a term $M$ has type $A$ then $M$ is strongly normalizing and its reduction is finite, choosing $\sigma$ to be the identity substitution.
% \\[1em]
% We remark first, that all variables are in the semantic type $A$ and variables are strongly normalizing, i.e. they are already in normal form.

% % \begin{lemma}~\\
%   \begin{itemize}
%   \item If $\Gamma \vdash x : A$ then $\Gamma \models x : A$
%   \item If $\Gamma \vdash x : A$ then $(\Gamma \vdash x) \in \SN$.
%   \end{itemize}

% \end{lemma}

% These are of course statements we need to prove.

\section{Defining strongly normalizing terms}
\subsection{Definition of strong normalization via accessibility relation}
Intuitively, a term $M$ is strongly normalizing, if there exists no infinite reduction sequence. Constructively, we can define strong normalization as follows:

\begin{definition}\label{def:norm}
A term $M$ of type $A$ is strongly normalizing, if all its reducts are strongly
normalizing.\\
\[
\infer{\Gamma \vdash M : A \in \csn}
      {\Gamma \vdash M : A & \forall M'.~\Gamma \vdash M \red M' : A \imply \Gamma \vdash M' : A \in \csn}
\]
\end{definition}

The usual definition of strong normalization via accessibility does not only consider well-typed terms. However, as we follow a type-directed reduction strategy, it is natural to define strong normalization on well-typed terms.

From this definition, it easily follows:

 \begin{lemma}[Multi-step Strong Normalization]\label{lm:mredsn}
If  $\Gamma \vdash M \mred M' : B$ and
   $\D:\Gamma \vdash M : B \in \csn$ then $\D':\Gamma \vdash M' : B \in \csn$ and $\D' < \D$.
 \end{lemma}
 \begin{proof}
Induction on $\Gamma \vdash M\mred M' : B$ .

\paragraph{Case} $\ianc{}{\Gamma \vdash M \mred M' : B}{\Gamma \vdash M \red M' : B} \qquad$
\\[1em]
$\D' : \Gamma \vdash M' : B \in \csn$ and $\D' < \D$ \hfill by using $\D:\Gamma \vdash M : B \in \csn$

\paragraph{Case} $ \ibnc{\Gamma \vdash M \red N : B}{\Gamma \vdash N \mred M' : B}
      {\Gamma \vdash M \mred M' : B}{}$
\\[1em]
$\D : \Gamma \vdash M : B \in \csn$ \hfill by assumption\\
$\D_1 : \Gamma \vdash N : B \in \csn$ and $\D_1 < \D$ \hfill by using $\D: \Gamma \vdash M : B \in \csn$\\
$\D_2 : \Gamma \vdash M' : B \in \csn$ and $\D_2 < \D_1$ \hfill by IH using $\D_1$ \\
$\D_2 < \D$ \hfill since $\D_2 < \D_1$ and $\D_1 < \D$ 

 \end{proof}

To check strong normalizability of a term $M$ it is sufficient to consider every one-step
reduct of $M$ instead of all possible (potentially infinite) reduction sequences. In particular, we can show that it enjoys the expected closure and substitution properties, namely:
\begin{enumerate}
\item $\Gamma \vdash R : A \arrow B \in \csn$ and $\Gamma \vdash N : A \in \csn$
    iff $\Gamma \vdash R~N : B \in \csn$;
  \item $\Gamma, x{:}A \vdash M : B \in \csn$ iff $\Gamma \vdash  \lambda x{:}A.M : A \arrow B \in \csn$;
  \item Let  $\Gamma \vdash R : A \in
   \csn$. Then $\Gamma, x{:}A \vdash M : B \in \csn$ if $\Gamma \vdash [R/x]M : B \in \csn$.
\end{enumerate}

Note that property 1 and property 3 are stated and only hold for neutral terms $R$. 
Before discussing these closure properties we first show that our definition of $\csn$ satisfies weakening.

\begin{lemma}[Weakening of strongly normalizing terms]\label{lm:wksn}
If $\Gamma \vdash M : B \in \csn$ then $\Gamma, x{:}A \vdash M : B \in \csn$\footnote{Maybe state it with explicit weakening and context extensions. -bp}.
\end{lemma}
\begin{proof}
By induction on $\Gamma \vdash M : B \in \csn$.
 \\[1em]
$\Gamma \vdash M : B$ \hfill by assumption $\Gamma \vdash M : B \in \csn$\\
$\Gamma, x{:}A \vdash M : B$ \hfill by weakening of typing\\
Assume $\Gamma, x{:}A \vdash M \red M' : B$\\
$\Gamma \vdash M \red M' : B$ \hfill by strengthening (Lemma \ref{lem:redprop}) \\
$\Gamma \vdash M' : B \in \csn$ \hfill by assumption $\Gamma \vdash M : B \in \csn$\\
$\Gamma, x{:}A \vdash M' : B \in \csn$  \hfill by IH\\
$\Gamma, x{:}A \vdash M : B \in \csn$ \hfill since $M'$ was arbitrary

\end{proof}

\begin{lemma}[Anti-renaming (Strengthening) of strongly normalizing terms]\label{lm:strsn}
If $\Gamma, x{:}A \vdash [\rho]M : B \in \csn$ and $\Gamma, x{:}A \ext{\rho} \Gamma$ then 
$\Gamma \vdash M : B \in \csn$.  
\end{lemma}
\begin{proof}
By induction on $\Gamma, x{:}A \vdash [\rho]M : B \in \csn$.
	\\[1em]
Assume $\Gamma \vdash M \red M' : B$ \\
$\Gamma, x{:}A \vdash [\rho]M \red [\rho]M' : B$ \hfill by weakening of typed. red. \\
$\Gamma, x{:}A \vdash [\rho]M' : B \in \csn$ \hfill using $\Gamma, x{:}A \vdash [\rho]M : B \in \csn$\\
$\Gamma \vdash M' : B \in \csn$ \hfill by IH

\end{proof}

\begin{lemma}[Properties of strongly normalizing terms]\label{lem:psn}$\;$
  \begin{enumerate}
  \item\label{pp3} If $\Gamma \vdash [N/x]M : B \in \csn$ and $\Gamma \vdash N : A$ then $\Gamma, x{:}A \vdash M : B \in \csn$.
  \item\label{pp4} If $\Gamma, x{:}A \vdash M : B \in \csn$ then $\Gamma \vdash  \lambda x{:}A.M : A \arrow B \in \csn$.
  \item\label{pp6} If $\Gamma \vdash M~N : B \in \csn$ then
     $\Gamma \vdash M : A \arrow B \in \csn$ and $\Gamma \vdash N : A\in \csn$.
  \item\label{pp7} If $\Gamma \vdash \lambda x{:}A.M : A \arrow B \in \csn$
     then $\Gamma, x{:}A \vdash M : B \in \csn$.
  \end{enumerate}
\end{lemma}
\begin{proof}
% Property \ref{pp2} is proven by mutual induction on the derivations; 
Each property is proven by induction on the first derivation. 
\\[1em]
In all the proofs below we silently exploit type uniqueness and do not track explicitly the reasoning about well-typed terms.
\\[1em]
 % \fbox{\ref{pp2}. If $\Gamma \vdash R : A \arrow B \in \csn$ and $\Gamma \vdash N : A \in \csn$
 %     then $\Gamma \vdash R~N : B \in \csn$. } where $R$ is not a lambda-abstraction.
 % \\[1em]
 % By simultaneous induction on $\Gamma \vdash R : A \arrow B \in \csn$,~
 % $\Gamma \vdash N : A \in \csn$. \\[1em]
 % Assume $\Gamma \vdash R~N \red Q : B$
 % \paragraph{Sub-case:} $\D = \ibnc
 %  {\Gamma \vdash R \red R' : A \arrow B}{\Gamma \vdash N : A}
 %  {\Gamma \vdash R\,N \red R'\,N : B}{}$ and $Q = R'~N$
 % \\[1em]
 % $\Gamma \vdash R' : A \arrow B \in \csn$ \hfill by using assumption $\Gamma \vdash R : A \arrow B \in \csn$ \\
 % $\Gamma \vdash R'~N : B \in \csn$ \hfill by IH \\
 % $\Gamma \vdash Q : B \in \csn$ \hfill since $Q = R'~N$
 % % $\Gamma \vdash R~N \in \csn$ \hfill by abstraction over assumption $\Gamma \vdash R~N \red Q$.
 %
 % \paragraph{Sub-case:} $\D = \ibnc
 %  {\Gamma \vdash N \red N' : A}{\Gamma \vdash R : A \arrow B}
 %  {\Gamma \vdash R\,N \red R\,N' : B}{}$ and $Q = R~N'$
 % \\[1em]
 % $\Gamma \vdash N' : A \in \csn$ \hfill by using assumption $\Gamma \vdash N : A \in \csn$ \\
 % $\Gamma \vdash R~N' : B\in \csn$ \hfill by IH \\
 % $\Gamma \vdash Q : B \in \csn$ \hfill since $Q = R~N'$
 % % $\Gamma \vdash R~N \in \csn$ \hfill by abstraction over assumption $\Gamma \vdash R~N \red Q$.
%
% % \paragraph{Sub-case:} $\D = \Gamma \vdash (\lambda x{:}A.M)\;N  \red  \Gamma \vdash [N/x]M : B$
% % \\[1em]
% % $\Gamma \vdash \lambda x{:}A.M : A \arrow B$ \hfill by assumption of $\beta$-reduction \\
% % $\Gamma \vdash N : A$  \hfill by assumption of $\beta$-reduction \\
% % $\Gamma \vdash \lambda x{:}A.M : A \arrow B \in \csn$ \hfill by assumption \\
% % $\Gamma \vdash N : A \in \csn$ \hfill by assumption \\
% % $\Gamma, x{:}A \vdash M : B \in \csn$ \hfill Property \ref{pp7}\\
% % $\Gamma \vdash [N/x]M : B \in \csn$ \hfill by Property \ref{pp5}
% %
% % \paragraph{Sub-case:} $\D = \Gamma \vdash (M~N) \red \lambda x{:}A_1.(M~N)~x : A_1 \arrow A_2$ where $B = A_1 \arrow A_2$
% % \\[1em]
% % $\Gamma \vdash M~N : A_1 \arrow A_2 \in \csn$ \hfill by assumption \\
% % $\Gamma, x{:}A_1 \vdash M~N : A_1 \arrow A_2 \in \csn$ \hfill by weakening \\
% % $\Gamma, x{:}A_1 \vdash x : A_1 \in \csn$ \hfill by since variables do not step \\
% % $\Gamma, x{:}A_1 \vdash (M~N)~x : A_2 \in \csn$ \hfill IH since $A_2$ is smaller than $B$
% % \\
% % $\Gamma \vdash \lambda x{:}A.(M~N)~x : A \arrow B \in \csn$ \hfill by Property \ref{pp4}
% %\\[1em]
% % $\Gamma \vdash M~N : B \in \csn$ \hfill since $\Gamma \vdash M~N \red Q : B$ was arbitrary.
% % \\[1em]
%
\vspace{1em}
% \noindent
\fbox{\ref{pp3}. If $\Gamma \vdash [N/x]M : B \in \csn$ and $\Gamma \vdash N : A$ then $\Gamma, x{:}A \vdash M : B\in \csn$.}
\\
Induction on $\Gamma \vdash [N/x]M : B \in \csn$. \\[1em]
Assume $\Gamma, x{:}A \vdash M \red M' : B$\\
$\Gamma \vdash [N/x]M \red [N/x]M' : B$ \hfill by Lemma \ref{lem:redsubst}\\
$\Gamma \vdash [N/x]M' : B \in \csn$ \hfill by using  $\Gamma \vdash [N/x]M : B \in \csn$ \\
$\Gamma, x{:}A \vdash M' : B \in \csn$ \hfill by IH\\
$\Gamma, x{:}A \vdash M : B \in \csn$ \hfill since $\Gamma, x{:}A \vdash M \red M' : B$ was arbitrary.
\\[1em]
% By induction on $M$.
% \paragraph{Sub-case:} $M = x$ \\
% $\Gamma, x{:}A \vdash x : A \in \csn$ \hfill trivial since there is no reduction $\Gamma, x{:}A \vdash x \red x : A$
%
% \paragraph{Sub-case:} $M = y$ and $\Gamma = \Gamma_1, y{:}B, \Gamma_2$\\
% $\Gamma, x{:}A \vdash y : B \in \csn$ \hfill  trivial since there is no reduction $\Gamma, x{:}A \vdash y \red y : B$
%
% \paragraph{Sub-case:} $M = M_1~M_2$ \\
% $[N/x](M_1~M_2) = [N/x]M_1~[N/x]M_2$ \hfill by def. of subst. \\
% $\Gamma \vdash [N/x]M_1 : C \arrow B \in \csn$ and $\Gamma \vdash [N/x]M_2 : C\in \csn$ \hfill by Property \ref{pp6} \\
% %$\Gamma \vdash [N/x]M_2 \in \csn$ \hfill by Property \ref{pp6} \\
% $\Gamma, x{:}A \vdash M_1  : C \arrow B \in \csn$ \hfill by IH \\
% $\Gamma, x{:}A \vdash M_2  : C \in \csn$ \hfill by IH \\
% {\color{red}{$\Gamma, x{:}A \vdash M_1~M_2 : B \in \csn$ \hfill by Property \ref{pp2} -- $M_1$ is not neutral}}
% %
%
% \paragraph{Sub-case:} $M = \lambda y{:}A'.M'$ \\
% $[N/x](\lambda y{:}A'. M') = (\lambda y{:}A'. [N/x]M')$ \hfill by def. subst.\ednote{Should we insist on $(\lambda y{:}A'. [N/x,y/y]M')$? .am  I think it doesn't matter here whether one uses simultaneous subst. or single subst. -bp} \\
% $\Gamma, y{:}A' \vdash [N/x]M' :B \in \csn$ \hfill by Property \ref{pp7}\\
% $\Gamma, y{:}A', x{:}A \vdash M' : B \in \csn$ \hfill by IH \\
% $\Gamma, x{:}A, y{:}A' \vdash M' : B \in \csn$ \hfill by exchange \\
% $\Gamma, x{:}A \vdash \lambda y{:}A'.M' : A' \arrow B \in \csn$ \hfill by Property \ref{pp4}
% \\[1em]
% %
\fbox{\ref{pp4}. If $\Gamma, x{:}A \vdash M : B \in \csn$ then $\Gamma \vdash  \lambda x{:}A.M : A \arrow B\in \csn$}
\\[1em]
Induction on $\Gamma, x{:}A \vdash M : B \in \csn$. \\[1em]
Assume $\Gamma \vdash \lambda x{:}A.M \red Q : A \arrow B$\\
$\Gamma, x{:}A \vdash M \red M' : B$ and $Q = \lambda x{:}A.M'$ \hfill by reduction rule for $\lambda$.\\
$\Gamma, x{:}A \vdash M' : B \in \csn$ \hfill by assumption $\Gamma, x{:}A \vdash M : B\in \csn$ \\
$\Gamma \vdash \lambda x{:}A.M' : A \arrow B\in \csn$ \hfill by IH \\
$\Gamma \vdash Q : A \arrow B \in \csn$ \hfill since $Q = \lambda x{:}A.M'$\\
$\Gamma \vdash \lambda x.M : A \arrow B \in \csn$ \hfill since $\Gamma \vdash \lambda x.M \red Q : A \arrow B$ was arbitrary
\\[1em]
%
%
% \fbox{\ref{pp5}. If $\Gamma, x{:}A \vdash M : B \in \csn$ and $\Gamma \vdash R : A \in
%    \csn$ then $\Gamma \vdash [R/x]M : B \in \csn$.  }{\color{red}{~~not used -- can be removed -bp}}
% \\[1em]
%
% Induction on $M$.
% % \\[1em]
% \paragraph{Sub-case:} $M = x$
% \\
% $\Gamma \vdash [R/x]x : A \in \csn$ \hfill by assumption $\Gamma \vdash R : A \in \csn$
% %
% \paragraph{Sub-case:} $M = y$
% \\
% $\Gamma \vdash [R/x]y : B \in \csn$ \hfill since $[R/x]y = y$ and variables do not step, trivial.
% %
% \paragraph{Sub-case:} $M = M_1~M_2$  \hfill TODO!
% \\
% $\Gamma,x{:}A \vdash M_1~M_2 : B\in \csn$ \hfill by assumption \\
% $\Gamma, x{:}A \vdash M_1 : C \arrow B \in \csn$ and $\Gamma, x{:}A \vdash M_2 : C\in \csn$ \hfill by Property \ref{pp6} \\
% $\Gamma \vdash [R/x]M_1 : C \arrow B \in \csn$ \hfill by IH \\
% $\Gamma \vdash [R/x]M_2 : C \in \csn$ \hfill by IH \\
% {\color{red}{$\Gamma \vdash [R/x]M_1~[R/x]M_2 : B \in \csn$ \hfill by Property \ref{pp2} -- $[R/x]M_1$ is not neutral}}\\
% $\Gamma \vdash [R/x](M_1~M_2) : B \in \csn$ \hfill by subst. def.
% %
% \paragraph{Sub-case:} $M = \lambda y{:}B.M'$
% \\
% $\Gamma, x{:}A \vdash \lambda y{:}B.M' : B \arrow C \in \csn$ \hfill by assumption \\
% $\Gamma, x{:}A, y{:}B \vdash M' : C \in \csn$ \hfill by Property \ref{pp7}\\
% $\Gamma, y{:}B, x{:}A \vdash M' : C \in \csn$ \hfill by exchange \\
% $\Gamma, y{:}B \vdash R : A \in \csn$ \hfill by weakening\\
% $\Gamma, y{:}B \vdash [R/x]M' : C \in \csn$ \hfill by IH \\
% $\Gamma \vdash \lambda y{:}B. [R/x]M' : B \arrow C \in \csn$ \hfill by Property \ref{pp4}\\
% $\Gamma \vdash [R/x](\lambda y{:}B.M') : B \arrow C \in \csn$ \hfill by subst. def
% \\[1em]
\fbox{\ref{pp6}. If $\Gamma \vdash M~N : B \in \csn$
                 then $\Gamma \vdash M : A \arrow B \in \csn$ and $\Gamma \vdash N : A \in \csn$.}
\\[1em]
We prove first: If $\Gamma \vdash M~N : B\in \csn$ then $\Gamma \vdash M : A \arrow B\in \csn$.
Proving $\Gamma \vdash M~N : B \in \csn$ implies also $\Gamma \vdash N : A\in \csn$ is similar.
\\
By induction on $\Gamma \vdash M~N : B \in \csn$.
\\[1em]
Assume $\Gamma \vdash M \red M': A \arrow B $\\
$\Gamma \vdash M~N \red M'~N : B $ \hfill by reduction rule for application \\
$\Gamma \vdash M'~N : B \in \csn$ \hfill by assumption $\Gamma \vdash M~N \in \csn$\\
$\Gamma \vdash M' : A \arrow B \in \csn$ \hfill by IH\\
$\Gamma \vdash M  : A \arrow B \in \csn$ \hfill since $\Gamma \vdash M \red M' : A \arrow B$ was arbitrary
\\[1em]
\fbox{\ref{pp7}. If $\Gamma \vdash \lambda x{:}A.M : A \arrow B\in \csn$
    then $\Gamma, x{:}A \vdash M : B \in \csn$. }
\\[1em]
By induction on $\Gamma \vdash \lambda x{:}A.M : A \arrow B \in \csn$.
\\[1em]
Assume  $\Gamma, x{:}A \vdash M \red M' : B$\\
$\Gamma \vdash \lambda x{:}A.M \red \lambda x{:}A.M' : A \arrow B$ \hfill by reduction rules for $\lambda$\\
$\Gamma \vdash \lambda x{:}A. M' : A \arrow B \in \csn$ \hfill by assumption $\Gamma \vdash \lambda x{:}A.M\in\csn$\\
$\Gamma, x{:}A \vdash M' : B \in \csn$ \hfill by IH\\
$\Gamma, x{:}A \vdash M : B \in \csn$ \hfill since  $\Gamma, x{:}A \vdash M \red M'$ was arbitrary
\\[1em]
\end{proof}


% \begin{corollary}\label{cor:psn}~
% If $\Gamma \vdash   [N/x]M : B \in \csn$
%                   and $\Gamma \vdash N : A \in \csn$
%                  then $\Gamma \vdash (\lambda x.M) \;N : B\in \csn$.
% \end{corollary}
% \begin{proof}
% Follows directly from Lemma
%  {\color{red}{\ref{lem:psn}(\ref{pp3})}}, Lemma
%   \ref{lem:psn}(\ref{pp4}) and  {\color{red}{Lemma
%       \ref{lem:psn}(\ref{pp2}) -- cannot be used, since $\lambda x.M$
%       is not neutral}}.
% \end{proof}


\subsection*{Closure properties of strongly normalizating terms}
% Previously, we only defined single step reductions. To talk about normalization of a term, we also need to be % able to chain single step reductions together and reason about reduction sequences.
% Recall that a term $M$ is said to be \emph{weakly} normalising if there is a  rewrite sequence starting in $M$ that eventually ends in a normal form. A  term $M$ is said to be \emph{strongly} normalising, if \emph{all} rewrite sequences starting in $M$ end eventually in a  normal form.  We can then in fact give a rather easy definition of all weakly normalizing terms

% One common approach is to define a multi-step relation on top of the single step reduction we have defined. This approach can become verbose as we extend our language with new constructs and types.

Let us begin by contrasting weak and strong normalization. A term $M$ is said to be \emph{weakly} normalising if there is a  rewrite sequence starting in M that eventually ends in a  normal form. A  term $M$ is said to be \emph{strongly} normalising if all rewrite sequences starting in M end eventually in a  normal form.

As pointed out by \cite{Raamsdonk_onnormalisation}, we can easily characterize all weakly normalising terms as follows: a  weakly normalising term is a normal form or can be obtained as the result of some expansion starting in a  normal form. Following this idea, we can then characterize elegantly strongly normalizing terms also as the closure under expansion where expansion is subject to two restrictions: first, the argument of the redex introduced by the expansion step should be in the set of strongly normalising terms, and second, the expansion step should yield a new head redex (backwards closure) or a  new outermost redex in a  term without a  head redex. This idea will form the essence of the closure properties we state next and also gives rise to an inductive definition of strongly normalizing terms which we give in the next section.

To compactly state closure properties and congruence rules, we rely on evaluation contexts which we define below:

\[
\begin{array}{lcl}
\mbox{Evaluation Context}~C & \bnfas & {\_} ~\mid C~M
\end{array}
\]

An evaluation context is a term with a hole, written as an underscore.

Using evaluation contexts, we can describe the term $x~M_1 \ldots M_n$ using the evaluation context $C = \_~M_1 \ldots M_n$ and simply instantiate the hole with $x$ writing $C[x]$ for $x~M_1 \ldots M_n$. We can also represent the term $x~M_1 \ldots M_n$ choosing the evaluation context $C' = \_~M_1 \ldots M_{n-1}$ writing $C'[x]~M_n = C[x]$.

Similarly, choosing $C = \_ ~N_1 \ldots N_k$ and instantiating the hole with $\lambda x{:}A.M$ we describe a term $C[\lambda x{:}A.M] = (\lambda x{:}A.M)~N_1 \ldots N_k$ which has a redex. Moreover, when choosing the evaluation context $C' = \_~N_2 \ldots N_k$ we have $C'[(\lambda x{:}A.M)~N_1] = C[\lambda x{:}A.M]$.


% Then we only have one reduction rule for evaluation contexts

% \[
%   \begin{array}{c}
% \ianc{\Gamma \vdash M \red M' : A}
%      {\Gamma \vdash C[M] \red C[M'] : A}{}
%   \end{array}
% \]

% where $M$ is the sub-term that we reduce.

Evaluation contexts are inductively defined -- they are either a hole or built by $C~M$ where $C$ is a smaller evaluation context containing a hole.

\begin{lemma}[Multi-step Reductions with Evaluation Contexts]\label{lm:mredecxt}
If $\Gamma \vdash M \mred N : B$ and $\Gamma, x{:}B \vdash C[x] : B'$
then $\Gamma \vdash C[M] \mred C[N] : B'$.  
\end{lemma}
\begin{proof}
By induction on the structure of $C$.  
\end{proof}

\begin{lemma}[Evaluation Contexts]\label{lm:ecxt}$\;$
If $\Gamma \vdash C[x]~N \red R : B$ then there exists an
    evaluation context $C'$ s.t. $R = C'[x]$.
\end{lemma}
\begin{proof}
By induction on the structure of evaluation contexts $C$.

\paragraph{Case}  $C = \_$
\\[1em]
$\Gamma \vdash x~N \red R : B$ \hfill by assumption since $C[x] = x$\\
$\Gamma \vdash x : A \arrow B$ and $\Gamma \vdash N \red N': A$ and $R = x~N'$ \hfill by inversion on the only applicable red. rule \\
So there exists an evaluation context $C'[x] = C[x]~N'$.


\paragraph{Case} $C  = C_0 ~M$ \\[1em]
$\Gamma \vdash (C_0[x]~M)~N \red R : B$ \hfill by assumption since $C[x] = C_0[x]~M$\\[1em]
\textbf{Sub-case} $\ianc{\Gamma \vdash (C_0[x]~M) \red R : A \arrow B \qquad \Gamma \vdash N : A}{\Gamma  \vdash (C_0[x]~M)\,N \red R\,N : B}{}$
\\[1em]
There exists an evaluation context $C_1[x] = R$ \hfill by IH \\
Therefore there exists an evaluation context $C'[x] = C_1[x]~N$
\\[1em]
\textbf{Sub-case} $\ianc{\Gamma \vdash (C_0[x]~M) : A \arrow B \qquad \Gamma \vdash N \red N' : A}{\Gamma \vdash (C_0[x]~M)\,N \red (C_0[x]~M)\,N' : B}{}$
\\[1em]
Hence there exists an evaluation context $C'$ s.t. $C'[x] = (C_0[x]~M)\,N'$.

\end{proof}

% Closure of SN under WH Expansion
% 1.
% If $\Gamma \vdash N \in \csn$
% and $\Gamma \vdash C[M[N/x]] \in \csn$
% then $\Gamma \vdash C[ (lam x.M)~N] \in \csn$.
% 2.
% If $\Gamma \vdash C[ (lam x.M)~N ] \red R$
% then $\Gamma \vdash C[ M[N/x] } \red R$
%
% 3.



Using evaluation contexts we can now state elegantly that strongly normalizing terms are closed under expansion.

% \begin{metanote}
% 	Properties (\ref{cp3}) and (\ref{cp3b}) follow from Lemma
%         \ref{lem:psn} (\ref{pp2}) as $C[x]$ corresponds to the terms
%         that \ref{lem:psn} (\ref{pp2}) applies to, and (\ref{cp2}) is
%         never actually referenced, but instead the same one-step proof
%         is repeated whenever we need to establish that a variable is
%         $\csn$. Do we really need these three properties? -ah
% \\[0.5em]
% I think we should restate \ref{lem:psn}(\ref{pp2}) as Property
% \ref{cp3} and rather remove \ref{lem:psn}(\ref{pp2}. -bp
% \end{metanote}


\begin{lemma}[Closure properties of neutral terms]\label{lm:closn}$\;$
  \begin{enumerate}
  \item\label{cp2} For all variables $x:A \in \Gamma$, $\Gamma \vdash x : A \in \csn$.
  \item\label{cp3} If $\Gamma \vdash C[x] : A \arrow B \in \csn$ and $\Gamma \vdash N : A \in \csn$
     then $\Gamma \vdash C[x]\,N : B \in \csn$.
% -- no used -bp
%  \item\label{cp3b} If $\Gamma \vdash C[x]~M \red R : B$ and $\Gamma \vdash C[x] : A \arrow B \in
%\csn$ and $\Gamma \vdash M : A \in \csn$ then $\Gamma \vdash R : B\in \csn$.
   % \item\label{cp4} If $\Gamma,x{:}A \vdash M \in \csn$ then $\Gamma \vdash \lambda x.M \in \csn$.
%   \item\label{cp5} {$\csn$-backward closure:} If $\Gamma \vdash M \redsn M' : A$ and $\Gamma \vdash M' : A \in \csn$ then
%     $\Gamma \vdash M : A \in \csn$ where
%\[
%\begin{array}{l}
%\infer{\Gamma \vdash (\lambda x.M)\;N \redsn [N/x]M : B}{\Gamma, x{:}A \vdash M : B \quad \Gamma \vdash N : A \in \csn }
%\qquad
%\infer{\Gamma \vdash M\;N \redsn M'\;N : B}{\Gamma \vdash M \redsn M' : A \arrow B \quad \Gamma \vdash N : A} %  M\,\text{is not a%}\;\lambda %  %& s \in \csn
%  \\[1em]
%\end{array}
%\]
\end{enumerate}
\end{lemma}
\begin{proof}\mbox{}~\\[1em]
\noindent
\fbox{\ref{cp2}.  For all variables $x:A \in \Gamma$, $\Gamma \vdash x : A \in \csn$.}
\\[1em]
$\forall M'.~\Gamma \vdash x \red M' : A \imply \Gamma \vdash M' : A \in \csn$ \hfill since $\Gamma \vdash x \red M'$ is impossible
\\
$\Gamma \vdash x : A $ \hfill since $x:A \in \Gamma$\\
$\Gamma \vdash x : A \in \csn$
\\[1em]
\fbox{
%  \begin{tabular}{lp{11cm}}
\ref{cp3}.  If $\Gamma \vdash C[x] : A \arrow B \in \csn$ and $\Gamma \vdash N : A \in \csn$
     then $\Gamma \vdash C[x]\,N : B \in \csn$.\\
 }
\\[1em]
 By simultaneous induction on $\Gamma \vdash C[x] : A \arrow B \in \csn$,~
 $\Gamma \vdash N : A \in \csn$. \\[1em]
 Assume $\Gamma \vdash C[x]~N \red Q : B$
 \paragraph{Sub-case:} $\D = \ibnc
  {\Gamma \vdash C[x] \red R' : A \arrow B}{\Gamma \vdash N : A}
  {\Gamma \vdash C[x]\,N \red R'\,N : B}{}$ and $Q = R'~N$
 \\[1em]
 $R' = C'[x]$ \hfill by Lemma \ref{lm:ecxt}\\
 $\Gamma \vdash C'[x] : A \arrow B \in \csn$ \hfill by using assumption $\Gamma \vdash C[x] : A \arrow B \in \csn$ \\
 $\Gamma \vdash C'[x]~N : B \in \csn$ \hfill by IH \\
 $\Gamma \vdash Q : B \in \csn$ \hfill since $Q = C'[x]~N = R'~N$
 % $\Gamma \vdash R~N \in \csn$ \hfill by abstraction over assumption $\Gamma \vdash R~N \red Q$.

 \paragraph{Sub-case:} $\D = \ibnc
  {\Gamma \vdash N \red N' : A}{\Gamma \vdash C[x] : A \arrow B}
  {\Gamma \vdash C[x]\,N \red C[x]\,N' : B}{}$ and $Q = C[x]~N'$
 \\[1em]
 $\Gamma \vdash N' : A \in \csn$ \hfill by using assumption $\Gamma \vdash N : A \in \csn$ \\
 $\Gamma \vdash C[x]~N' : B\in \csn$ \hfill by IH \\
 $\Gamma \vdash Q : B \in \csn$ \hfill since $Q = C[x]~N'$
\\[1em]
\noindent
% \fbox{\ref{cp3b}.
% If $\Gamma \vdash C[x]~M \red R : B $ and $\Gamma \vdash C[x] : A \arrow B \in \csn$
% and $\Gamma \vdash M : A \in \csn$
% then $\Gamma \vdash R : B \in \csn$. }
% \\[1em]
% Proof by simultaneous induction on $\Gamma \vdash C[x] : A \arrow B \in \csn$ and
% $\Gamma \vdash M : A \in \csn$.
% \\[0.5em]
% \textbf{Sub-case} $\ianc{\Gamma \vdash C[x] \red M' : A \arrow B \quad \Gamma \vdash N : A}
%                         {\Gamma \vdash C[x]\,N \red M'\,N : B}{}$
% \\[1em]
% $\Gamma \vdash M' : A \arrow B \in \csn$ \hfill by assumption $\Gamma \vdash C[x] : A \arrow B \in \csn$ \\
% $M'~N = C_0[x]$ \hfill by Lemma \ref{lm:ecxt} \\
% $M' = C_1[x]$ and hence $\Gamma \vdash C_1[x] : A \arrow B \in \csn$ \hfill by def. evaluation contexts \\
% $\Gamma \vdash N : A \in \csn$ \hfill by assumption \\
% $\Gamma \vdash C_1[x]~N : B \in \csn$ \hfill by IH(\ref{cp3}) since
% $\Gamma \vdash C_1[x] : A \arrow B \in \csn$ is smaller than $\Gamma \vdash C[x] \in \csn$
% % \\[1em]
% \\[1em]
% \textbf{Sub-case} $\ianc{\Gamma \vdash C[x] : A \arrow B \quad \Gamma \vdash N\red N' : A}{\Gamma \vdash C[x]\,N \red C[x]\,N' : B}{}$
% \\[1em]
% $\Gamma \vdash N' : A \in \csn$ \hfill by assumption $\Gamma \vdash N : A \in
% \csn$ \\
% $\Gamma \vdash C[x]~N' : B\in \csn$ \hfill by IH(\ref{cp3})
% \\[1em]
% \fbox{\ref{cp5}. If $\Gamma \vdash M\redsn M' : B$ and $\Gamma \vdash M' : B\in \csn$ then
%      $\Gamma \vdash M : B \in \csn$. }
% \\[1em]
%  Proof by induction on the first derivation.
%  \\
%  \paragraph{Case}$\D = \ianc{\Gamma \vdash N : A \in \csn \quad \Gamma, x{:} A \vdash M : B}
%                            {\Gamma \vdash (\lambda x.M)\;N \redsn [N/x]M : B}{}$
%  \\
%  $\Gamma \vdash [N/x]M : B \in \csn$ \hfill by assumption \\
%  {\color{red}{$\Gamma \vdash (\lambda x.M)\;N : B\in \csn$ \hfill by Corollary \ref{cor:psn}}}


%  \paragraph{Case} $\D =
%  \ianc {\Gamma \vdash M \redsn M' : B} % \qquad M\,\text{is not a}\;\lambda
%        {\Gamma \vdash M\;N \redsn M'\;N : B}{}$
%  \\[1em]
% $M$ is not a lambda-abstraction \hfill by assumption\\
%  $\Gamma \vdash M'\;N : B\in \csn$ \hfill by assumption \\
%  $\Gamma \vdash M' : A \arrow B \in \csn$ \hfill by Lemma \ref{lem:psn} (Property \ref{pp6})\\
%  $\Gamma \vdash M  : A \arrow B \in \csn$ \hfill by IH\\
%  $\Gamma \vdash N  : A \in \csn$ \hfill by Lemma \ref{lem:psn} (Property \ref{pp6})\\
%  $\Gamma \vdash M~N : B \in \csn$ \hfill by Lemma \ref{lem:psn} (Property \ref{pp2}), since $M$ is not a lambda-abstraction
% % IH If $\Gamma \vdash M' \csn then $\Gamma \vdash M \csn$
% %  H \Gamma \vdash M'\;N \in \csn
% % --------------------------------------
% %    \Gamma \vdash M\;N \in \csn


%   % \begin{enumerate}
%   % \item todo
%   % \item Immediate by definition.
%   % \item todo
%   % \item By induction on the given derivation
%   % \item todo
%   % \end{enumerate}
\end{proof}


\begin{lemma}[Composition of Evaluation Contexts]\label{lm:compecxt}\quad\\
If $\Gamma, x{:}A \vdash C[x] : B \in \csn$ 
and $\Gamma, y{:}A' \vdash C'[y]: A \in \csn$
then $\Gamma, y{:}A' \vdash C[C'[y]] : B \in \csn$.  
\end{lemma}
\begin{proof}
Induction on the structure of evaluation context $C$.

\paragraph{Case} $C = \underline{\quad}$
\\
$\Gamma, y{:}A' \vdash C'[y] : A \in \csn$ \hfill by assumption 

\paragraph{Case} $C = C_1[x]~[\rho]M$ s.t. $\Gamma, x{:}A \vdash  C_1[x]~M : B$ where $\Gamma \vdash M : B'$ and $\Gamma, x{:}A \ext{\rho} \Gamma$.
\\[0.5em]
Assume $\Gamma, y{:}A' \vdash C_1[C'[y]]~[\rho']M \red Q : B$ where $\Gamma, y{:}A' \ext{\rho'} \Gamma$.

\paragraph{Sub-case} $\ianc{\Gamma, y{:}A' \vdash [\rho']M \red M' : B'}
                          {\Gamma, y{:}A' \vdash C_1[C'[y]]~[\rho']M \red C_1[C'[y]]~M' : B}{}$ and $Q = C_1[C'[y]]~M' $
\\[0.5em]
$\Gamma, x{:}A \vdash C_1[x] : B' \arrow B \in \csn$ and $\Gamma, x{:}A \vdash [\rho]M : B' \in \csn$ \hfill by Lemma \ref{lem:psn} (Property \ref{pp6}) \\
$\Gamma, y{:}A' \vdash C_1[~C'[y]~] : B' \arrow B \in \csn$ \hfill by IH \\
$\Gamma \vdash M : B' \in \csn$ \hfill by Strengthening Lemma using
$\Gamma, x{:}A \vdash [\rho]M : B' \in \csn$ (Lemma \ref{lm:strsn})\\
$\Gamma, y{:}A' \vdash [\rho]M : B' \in \csn$ \hfill by Weakening Lemma for $\csn$ (Lemma \ref{lm:wksn})\\
%
$\Gamma, y{:}A' \vdash M' : B' \in \csn$ \hfill using $\Gamma, y{:}A' \vdash [\rho]M : B' \in \csn$ and $\Gamma, x{:}A' \vdash [\rho']M \red M' : B'$\\
$\Gamma, y{:}A' \vdash C_1[~C'[y]~]~M' : B \in \csn$ \hfill using Lemma \ref{lm:closn} (Property \ref{cp3})\\
$\Gamma, y{:}A' \vdash C_1[~C'[y]~]~[\rho']M$ \hfill since $\Gamma, y{:}A' \vdash C_1[C'[y]]~[\rho']M \red Q : B$ was arbitary.

\paragraph{Sub-case} $\ianc{\ianc{\Gamma, y{:}A' \vdash C'[y] \red Q' : A}
                                {\Gamma, y{:}A' \vdash C_1[C'[y]] \red C_1[Q'] : B' \arrow B}{}}
                          {\Gamma, y{:}A' \vdash C_1[C'[y]]~[\rho']M \red C_1[Q]~[\rho']M : B}{}$
\\[0.5em]
$Q' = C''[y]$ where $C' = \underline{\quad}~N_1 \ldots N_i \ldots N_n$ and 
$C'' = \underline{\quad}~N_1\ldots N'_i \ldots N_n$ where $\Gamma, y{:}A' \vdash N_i \red N'_i : B_i$
\\
$\Gamma, x{:}A \vdash C_1[x] : B' \arrow B \in \csn$ and $\Gamma, x{:}A \vdash [\rho]M : B' \in \csn$ \hfill by Lemma \ref{lem:psn} (Property \ref{pp6}) \\
$\Gamma \vdash M : B' \in \csn$ \hfill by Strengthening Lemma using $\Gamma, x{:}A \vdash [\rho]M : B' \in \csn$\\
$\Gamma, y{:}A' \vdash [\rho]M : B' \in \csn$ \hfill by Weakening Lemma \\
$\Gamma, y{:}A' \vdash C''[y] : A \in \csn$ \hfill using $\Gamma, y{:}A' \vdash C'[y] : A \in \csn$\\
$\Gamma, y{:}A' \vdash C_1[C''[y]] : B' \arrow B \in \csn$ \hfill by IH \\
$\Gamma, y{:}A' \vdash C_1[C''[y]] ~[\rho']M  : B \in \csn$\hfill using Lemma \ref{lm:closn} (Property \ref{cp3})\\
$\Gamma, y{:}A' \vdash C_1[C'[y]]~[\rho']M : B \in \csn$ \hfill by since $\Gamma, y{:}A' \vdash C_1[C'[y]]~[\rho']M \red Q : B$ was arbitrary

\end{proof}


\begin{lemma}\label{lem:appsnclosure}
If $\Gamma, x{:}A \vdash M : B \in \csn$ and $\Gamma \vdash N : A \in \csn$
and $\Gamma \vdash C[~[N/x]M~] : B \in \csn$ 
and $\Gamma, x{:}B \vdash C[x] : B' \in \csn$
then $\Gamma \vdash C[\,(\lambda x.M)~N\,] : B' \in \csn$
\end{lemma}
\begin{proof}
Proof by induction -- either $\Gamma, x{:}A \vdash M : B \in \csn$ is getting smaller,  
$\Gamma \vdash N : A \in \csn$ is getting smaller, or 
$\Gamma \vdash C[~[N/x]M~] : B \in \SN$  is getting smaller\ednote{In the Agda implementation, this lemma uses $\Gamma \vdash C[~[N/x]M~] : B \in \SN$ which means it cannot be proven independently; this does not make sense to me. Otherwise the proof follows the same main ideas. -bp}.
\\[1em]
\noindent
Assume  $\Gamma \vdash C[(\lambda x.M)~N] \red P : B'$.

\paragraph{Case} $\ianc{\above{\D}{\Gamma \vdash (\lambda x.M)~N \red Q}}{\Gamma \vdash C[(\lambda x.M)~N] \red C[Q] : B'}{}$. i.e. we reduce in the head position.
\\[0.5em]

% \paragraph{Case} $\ianc{\Gamma \vdash (\lambda x.M)~N \red Q}{\Gamma \vdash C[(\lambda x.M)~N] \red C[Q] : B'}{}$.

 \paragraph{Sub-Case} 
  $\D = \ianc {\Gamma \vdash \lambda x{:}A.M : A \arrow B 
         \quad \Gamma \vdash  N : A}
              {\Gamma \vdash (\lambda x{:}A.M)~N  \red [N/x]M : B }{}$ and $ Q = [N/x]M$
 \\
$\Gamma \vdash C[~[N/x]M ~] \in \csn$ \hfill by assumption

\paragraph{Sub-Case}
 $\D = \ianc {\ianc{\Gamma, x{:}A \vdash M \red M' : B}
                   {\Gamma \vdash \lambda x{:}A.M \red \lambda x{:}A.M' : A \arrow B }{}
        \quad \Gamma \vdash N : A}
             {\Gamma \vdash (\lambda x{:}A.M)~N \red (\lambda x{:}A.M')~N : B}{}$ 
 and $Q = (\lambda x{:}A.M')~N$
\\[0.5em]
$\Gamma, x{:}A \vdash M' : B \in \csn$ \hfill using $\Gamma, x{:}A \vdash M : B \in \csn$\\
$\Gamma \vdash N : A \in \csn$ \hfill by assumption \\
$\Gamma, x{:}A \vdash C[x] : B' \in \csn$ \hfill by assumption \\
$\Gamma \vdash [N/x]M \red [N/x]M' : B$ \hfill by Subst. Lemma for Typed Red\\
$\Gamma \vdash C[~[N/x]M~] \red C[~[N/x]M'] : B'$ \hfill by congruence \\
$\Gamma \vdash C[~[N/x]M'] : B' \in \csn$ \hfill by using $\Gamma \vdash C[~[N/x]M~] : B' \in \csn$ \\
$\Gamma \vdash C[\, (\lambda x{:}A.M')~N\;] : B'$ \hfill by IH

\paragraph{Sub-Case}
 $\D = \ianc {\Gamma \vdash \lambda x{:}A.M : A \arrow B 
        \quad \Gamma \vdash N \red N' : A}
             {\Gamma \vdash (\lambda x{:}A.M)~N \red (\lambda x{:}A.M)~N' : B}{}$
\\[0.5em]
$\Gamma \vdash N' : A \in \csn$ \hfill using $\Gamma \vdash N : A \in \csn$\\
$\Gamma \vdash \lambda x{:}A.M : A \arrow B$ \hfill by assumption \\
$\Gamma, x{:}A \vdash M : B $ \hfill by inversion on typing\\
$\Gamma \vdash [N/x]M \mred [N'/x]M : B$ \hfill by Lemma \ref{lm:mredprop}(\ref{lm:mredsubs}) using $\Gamma \vdash N \red N' : A$\\
$\Gamma \vdash C[~[N/x]M~] \mred C[~[N'/x]M~] : B'$ \hfill by Multi-Step Red. on Eval. Ctx. (Lemma \ref{lm:mredecxt})\\
$\Gamma \vdash C[~[N'/x]M] : B' \in \csn$ \hfill Lemma \ref{lm:mredsn} using $\Gamma \vdash C[~[N/x]M~] : B' \in \csn$\\
$\Gamma, x{:}A \vdash M : B \in \csn$ \hfill by assumption \\
$\Gamma, x{:}B \vdash C[x] : B' \in \csn$ \hfill by assumption \\
$\Gamma \vdash C[~(\lambda x{:}A.M)~N'~] : B' \in \csn$ \hfill by IH % (since $\Gamma \vdash N' : A \in \csn$ is smaller)

\paragraph{Case} $\D = \Gamma \vdash C[~(\lambda x.M)~N~] \red C'[~(\lambda x.M)~N~]$, i.e. we reduce, but not in a head position; if $C = \underline{\quad}~N_0\ldots N_n$ and there is a reduction $\Gamma \vdash N_i \red N'_i : A_i$. Furthermore $C' = \underline{\quad}~N_0\ldots N'_i \ldots N_n$\footnote{I would prefer a more structural argument based on the structure of evaluation contexts, but this works for now. -bp}
\\[0.5em]
$\Gamma \vdash  C[~[N/x]M~] \red  C'[~[N/x]M~] : B'$ \hfill by given assumption \\
$\Gamma \vdash C'[~[N/x]M~] : B' \in \csn$ \hfill using  $\Gamma \vdash C[~[N/x]M~] : B \in \csn$ 
\\
$\Gamma \vdash C'[\,(\lambda x.M)~N\,] : B' \in \csn$ \hfill by IH.

\end{proof}


\subsection{Inductive Definition of Strongly Normalizing Terms}
Following \cite{Raamsdonk_onnormalisation} and \cite{Joachimski2003} we define inductively the set of normal terms, $\SN$, and the set of neutral terms, $\SNe$, using the following judgments:
\\%[1em]

\begin{center}
\begin{tabular}{ll}
$\Gamma \vdash M : A \in \SN$  & $M$ is in the set of normal terms of  type $A$\\
$\Gamma \vdash M : A \in \SNe$ & $M$ is in the set of neutral terms of type $A$
\end{tabular}
\end{center}

Our inductive definition given in Fig.~\ref{fig:sn} tracks typing information, as before. This will allow us to easily extend our framework with the unit type.
As \cite{Raamsdonk_onnormalisation} observed, many proofs, not only normalization proofs, become simpler using the inductive definition, since it allows us  to prove properties by structural induction. This is in contrast to the accessibility notion of strong normalization where we often have to reason about reduction sequences and about positions of terms. As \cite{Joachimski2003}  put it: ``the reduct analysis becomes increasingly annoying in normalization proofs for more and more complex systems.'' Using the inductive definition of normal and neutral terms, we reduce the task of checking all one-step reducts to analysing no more than one standard reduct
and some subterms.  The proof of equivalence between the inductive notion of normalization and the accessibility notion given earlier is in fact the only place where reduct analysis has to be carried out.
Hence this approach seems particularly amendable to mechanizing proofs.

% introducing strictly positive inductive definitions of the underlying con-
% cepts, thus abandoning geometric notions (such as positions in terms, reduction trees and reduction
% sequences)


\begin{figure}
  \centering
\[
\begin{array}{c}
\multicolumn{1}{l}{\mbox{Neutral terms}} \\[1em]
\ianc{x{:}A \in \Gamma}{\Gamma \vdash x : A \in \SNe}{} \qquad
\ibnc{\Gamma \vdash R : A \arrow B \in \SNe}{\Gamma \vdash M : A \in \SN}{\Gamma \vdash R\,M : B \in \SNe}{}
\\[1em]
\multicolumn{1}{l}{\mbox{Normal terms}} \\[1em]
\ianc{\Gamma \vdash R : A \in \SNe}{\Gamma \vdash R : A \in \SN}{} \qquad
\ianc{\Gamma, x{:}A \vdash M : A \arrow B \in \SN}{\Gamma \vdash \lambda x{:}A.M : A \arrow B \in \SN}{} \qquad
\ibnc{\Gamma \vdash M \redSN M' : A}{\Gamma \vdash M' : A \in \SN}{\Gamma \vdash M : A \in \SN}{}
\\[1em]
\multicolumn{1}{l}{\mbox{Strong head reduction}} \\[1em]
\ianc{\Gamma \vdash N : A \in \SN \quad \Gamma, x{:}A \vdash M : B}{\Gamma \vdash (\lambda x.M)\;N \redSN [N/x]M : B}{} \qquad
\ianc{\Gamma \vdash R \redSN R' : A \arrow B \quad \Gamma \vdash M : A}{\Gamma \vdash R\,M \redSN R'\,M : B}{}
\end{array}
\]
  \caption{Inductive definition of strongly normalizing terms}
  \label{fig:sn}
\end{figure}


\begin{lemma}[$\SN$ and $\SNe$ characterize well-typed terms]\quad
  \begin{enumerate}
  \item If $\Gamma \vdash M : A \in \SN$ then $\Gamma \vdash M : A$.
  \item If $\Gamma \vdash M : A \in \SNe$ then $\Gamma \vdash M : A$.
  \item If $\Gamma \vdash M \redSN M' : A$ then $\Gamma \vdash M : A$ and $\Gamma \vdash M' : A$.
  \end{enumerate}
\end{lemma}
\begin{proof}
By induction on the definition of $\SN$, $\SNe$, and $\redSN$.
\end{proof}

\begin{lemma}[Renaming]~\label{lm:renameSN}
  \begin{enumerate}
  \item If $\Gamma \vdash M : A \in \SN$ and $\Gamma' \ext{\rho} \Gamma$ then $\Gamma' \vdash [\rho]M : A \in \SN$
  \item If $\Gamma \vdash M : A \in \SNe$ and $\Gamma' \ext{\rho} \Gamma$ then $\Gamma' \vdash [\rho]M : A \in \SNe$
  \item If $\Gamma \vdash M \redSN N : A$ and $\Gamma' \ext{\rho} \Gamma$ then $\Gamma' \vdash [\rho]M \redSN [\rho]N : A$.
  \end{enumerate}
\end{lemma}
\begin{proof}
By induction on the first derivation.

\paragraph{Case:} $\D = \ianc{\Gamma \vdash R : A \in \SNe}{\Gamma \vdash R : A \in \SN}{} $
\\[1em]
$\Gamma' \vdash [\rho]R : A \in \SNe$ \hfill by IH (2) \\
$\Gamma' \vdash [\rho]R : A \in \SN$ \hfill by def. of $\SN$

\paragraph{Case:} $\D = \ianc{\Gamma, x{:}A \vdash M : B \in \SN}{\Gamma \vdash \lambda x{:}A.M : A \arrow B \in \SN}{}$
\\[1em]
$\Gamma', x{:}A \ext {\rho, x/x} \Gamma, x{:}A$ \hfill by def. of $\ext{\rho}$\\
$\Gamma', x{:}A \vdash [\rho, x/x]M : B \in \SN$ \hfill by IH (1) \\
$\Gamma' \vdash \lambda x{:}A.[\rho, x/x]M : A \arrow B \in \SN$ \hfill by def. of $\SN$\\
$\Gamma' \vdash [\rho](\lambda x{:}A.M) : A \arrow B \in \SN$ \hfill by subst. def.


% We will write $M \in \csn$ for $M$ is strongly normalizing in our ``informal definition'', i.e. all reduction sequences starting in $M$ are finite, to distinguish it from our inductive definition in Figure \ref{fig:sn}.

\paragraph{Case:} $\D = \ibnc{\Gamma \vdash M \redSN M' : A}{\Gamma \vdash M' : A \in \SN}{\Gamma \vdash M : A \in \SN}{} $
\\[1em]
$\Gamma' \vdash [\rho]M \redSN [\rho]M' : A$ \hfill by IH (3) \\
$\Gamma' \vdash [\rho]M' : A \in \SN$ \hfill by IH (1)\\
$\Gamma' \vdash [\rho]M  : A \in \SN$ \hfill by def. of $\SN$


\paragraph{Case:} $\D = \ianc{x{:}A \in \Gamma}{\Gamma \vdash x : A \in \SNe}{} $
\\[1em]
$\Gamma' \ext {\rho} \Gamma$ \hfill by assumption \\
$\Gamma' \vdash [\rho]x : A$ \hfill by renaming of typing \\
$\Gamma' \vdash [\rho]x : A \in \SNe$ \hfill by def. of $\SNe$

\paragraph{Case:} $\D = \ibnc{\Gamma \vdash R : A \arrow B \in \SNe}{\Gamma \vdash M : A \in \SN}{\Gamma \vdash R\,M : A \arrow B \in \SNe}{} $
\\[1em]
$\Gamma' \vdash [\rho]R : A \arrow B \in \SNe$ \hfill by IH (2) \\
$\Gamma' \vdash [\rho]M : A \in \SN$ \hfill by IH (1) \\
$\Gamma' \vdash [\rho]R~[\rho]M : A \arrow B \in \SNe$ \hfill by def. of $\SNe$\\
$\gamma' \vdash [\rho](R~M) : B \in \SNe$ \hfill by subst. def.

\paragraph{Case:}$\D = \ianc{\Gamma, x{:}A \vdash M : B \qquad \Gamma \vdash N : A \in \SN}{\Gamma \vdash (\lambda x{:}A.M)\;N \redSN [N/x]M : B}{} \qquad$
\\[1em]
$\Gamma' \vdash [\rho]N : A\in \SN$ \hfill by IH (1) \\
$\Gamma' \ext{\rho} \Gamma$ \hfill by assumption \\
$\Gamma', x{:}A \ext{\rho} \Gamma$ \hfill by weakening\\
$\Gamma', x{:}A \ext{\rho, x/x} \Gamma, x{:}A$ \hfill by def. of weakening subst\\
$\Gamma', x{:}A \vdash [\rho, x/x]M : B$ \hfill by weakening lemma \\
$\Gamma' \vdash (\lambda x{:}A.[\rho, x/x]M)~[\rho]N \redSN [\rho, [\rho]N/x]M : B$ \hfill by def. of $\redSN$\\
$\Gamma' \vdash [\rho]((\lambda x{:}A M)~N) \redSN [\rho]([N/x]M) : B$ \hfill by def. of subst

\paragraph{Case:}$\D = \ianc{\Gamma \vdash R \redSN R' : A \arrow B \quad \Gamma \vdash M : A}{\Gamma \vdash R\,M \redSN R'\,M : B}{}$\\[1em]
$\Gamma' \vdash [\rho]R \redSN [\rho]R': A \arrow B$ \hfill by IH(3) \\
$\Gamma' \vdash [\rho]M : A$ \hfill by weakening of typing \\
$\Gamma \vdash [\rho]R~[\rho]M \redSN [\rho]R'~[\rho]M : B$ \hfill by def. of $\redSN$\\
$\Gamma \vdash [\rho](R~M) \redSN [\rho](R'~M) : B$ \hfill by def. of subst.

\end{proof}

\begin{lemma}[Anti-Renaming]~\label{lm:anti-renameSN}
  \begin{enumerate}
  \item If $\Gamma' \vdash [\rho]M : A \in \SN$ and $\Gamma' \ext{\rho} \Gamma$ then $\Gamma \vdash M : A \in \SN$
  \item If $\Gamma' \vdash [\rho]M : A \in \SNe$ and $\Gamma' \ext{\rho} \Gamma$ then $\Gamma \vdash M : A \in \SNe$
  \item If $\Gamma' \vdash [\rho]M \redSN [\rho]N : A$ and $\Gamma' \ext{\rho} \Gamma$ then $\Gamma \vdash M \redSN N : A$.
  \end{enumerate}
\end{lemma}
\begin{proof}
By induction on the first derivation\ednote{Should the proof be
  expanded. -bp}.
\end{proof}


% \begin{lemma}[Stable under Substitution]\label{lem:SNsubst}\quad
%   \begin{enumerate}
%   \item If $\Gamma, x{:}A \vdash M : B \in \SN$ and $\Gamma \vdash N : A \in \SN$
%     then $\Gamma \vdash [N/x]M : B \in \SN$.
%   \item If $\Gamma, x{:}A \vdash R : B \in \SNe$ and $\Gamma \vdash N : A \in \SN$
%     then $\Gamma \vdash [N/x]R : B \in \SN$.
%   \item If $\Gamma, x{:}A \vdash M \redSN M' : B$ and $\Gamma \vdash N : A \in \SN$ then
%     $\Gamma \vdash [N/x]M \redSN [N/x]M' : B$.
%   \end{enumerate}
% \end{lemma}
% \begin{proof}
% Simultaneous induction on first derivation -- to proven together with lemma \ref{lm:pSN0} below.

% % We only show a few cases.

% %  \paragraph{Case}
% %   $\D = \ianc{\Gamma, x{:}A \vdash M' \in \SN}
% %              {\Gamma, x{:}A \vdash (\lambda y{:}B.M)~M' \redSN [M'/y]M}{}$
% %  \\[1em]
% %  $\Gamma \vdash [N/x]M' \in \SN$ \hfill by IH (1) \\
% %  $\Gamma \vdash (\lambda y{:}B.[N/x]M)~([N/x]M') \redSN [[N/x]M'/y]([N/x]M)$ \hfill by def of $\redSN$\\
% %  $[N/x](\lambda y{:}B.M)~M') = (\lambda y{:}B.[N/x]M)~([N/x]M')$ and \\
% %  $[N/x]([M'/y]M) = [[N/x]M'/y]([N/x]M)$ \hfill by subst. def.


% % \paragraph{Case}
% % $\D = \ianc{\Gamma, x{:}A \vdash R : B_1 \arrow B_2 \in \SNe \quad \Gamma, x{:}A \vdash M : B_1 \in \SN}
% %            {\Gamma, x{:} \vdash R~M : B_2 \in \SNe}{}
% % $
% % \\[1em]
% % $\Gamma \vdash [N/x]R : B_1 \arrow B_2 \in \SN$ \hfill by IH (2) \\
% % $\Gamma \vdash [N/x]M : B_1 \in \SN$ \hfill by IH (1) \\
% % $\Gamma \vdash [N/x]R~[N/x]M : B_2 \in \SN$ \hfill by \ref{lm:pSN0}

% \end{proof}

\begin{lemma}[$\SNe$ is closed under application\ednote{Not used  anymore? -bp}]\label{lm:pSN0}
If $\Gamma \vdash M : A \arrow B \in \SNe$ and $\Gamma \vdash N : A \in \SN$ then $\Gamma \vdash M~N : B \in \SN$.
\end{lemma}
\begin{proof}
$\Gamma \vdash M : A \arrow B \in \SNe$ \hfill by assumption \\
$\Gamma \vdash N : A \in \SN$ \hfill by assumption \\
$\Gamma \vdash M~N : B \in \SNe$ \hfill by def. of $\SNe$\\
$\Gamma \vdash M~N : B \in \SN$ \hfill by conversion of $\SNe$ to $\SN$

\end{proof} 




% \begin{metanote}
%   Does this work for $M$ as well? If it does, then extensionality follows -am
% \end{metanote}
% \begin{lemma}[Subterm Property of $\SN$]\label{lm:pSN2}
% If $\Gamma \vdash M~N : B \in \SN$ then $\Gamma \vdash N \in \SN$.
% \end{lemma}
% \begin{proof}
% By Induction on $\SN$.
% \paragraph{Case:} $\D =  \ianc{\Gamma \vdash R~N \in \SNe}{\Gamma \vdash R~N \in \SN}{}$
% \\[1em]
% $\Gamma \vdash N \in \SN$ \hfill by def. of $\SNe$

% \paragraph{Case:} $\D = \ibnc{\Gamma \vdash M~N \redSN Q}{\Gamma \vdash Q \in \SN}{\Gamma \vdash M~N \in \SN}{} $
% \\[1em]
% \textbf{Sub-Case:} $\D = \ianc{\Gamma \vdash N \in \SN}{\Gamma \vdash (\lambda x.M')\;N \redSN [N/x]M'}{}$ where $M = \lambda x.M'$\\[1em]
% $\Gamma \vdash N \in \SN$ \hfill by assumption
% \\[1em]
% \textbf{Sub-Case:} $\D = \ianc{\Gamma \vdash R \redSN R'}{\Gamma \vdash R\,M \redSN R'\,M}{}$
% \\[1em]
% $\Gamma \vdash R'\;M \in \SN$ \hfill by assumption since $Q = R'~M$\\
% $\Gamma \vdash M \in \SN$ \hfill by IH

% \end{proof}


We will use the extensionality of $\SN$ for function types in the proof of \CR1:

\begin{lemma}[Extensionality of $\SN$]\label{lm:pSN}
If  $x{:}A \in \Gamma$ and $\Gamma \vdash M~x : B \in \SN$ then $\Gamma \vdash M : A \arrow B \in \SN$.
\end{lemma}
\begin{proof}
By induction on $\SN$

\paragraph{Case:} $\D = \ianc{\Gamma \vdash M~x : B \in \SNe}{\Gamma \vdash M~x : B \in \SN}{} $  \\[1em]
 $\Gamma \vdash M : A \arrow B  \in \SNe$ \hfill by def. of $\SNe$ \\
 $\Gamma \vdash M : A \arrow B \in \SN$ \hfill by def. of $\SN$
 \\[1em]
 \paragraph{Case:} $\D = \ibnc{\Gamma \vdash M~x \redSN Q : B}{\Gamma \vdash Q : B\in \SN}
                             {\Gamma \vdash M~x : B \in \SN}{} $
 \\[1em]
 \textbf{Sub-case}: $\Gamma \vdash (\lambda y{:}A.M')~x \redSN [x/y]M' : B$ \\[1em]
 $\Gamma \vdash [x/y]M' : B \in \SN$ \hfill by assumption \\
 $\Gamma, y{:}A \vdash M' : B \in \SN$ \hfill by Anti-Renaming Property (Lemma \ref{lm:anti-renameSN})\\
 $\Gamma \vdash \lambda y{:}A.M' : A \arrow B \in \SN$ \hfill by def. of $\SN$
 \\[1em]
 \textbf{Sub-case}: $\Gamma \vdash M~x \redSN M'~x : B$ and $Q = M'~x$ \\[1em]
 $\Gamma \vdash M \redSN M' : A \arrow B$ \hfill by def. of $\redSN$ \\
 $\Gamma \vdash M' : A \arrow B \in \SN$ \hfill by IH \\
 $\Gamma \vdash M  : A \arrow B \in \SN$ \hfill by def. of $\SN$

% To Show: \Gamma \vdash M \in \SN$
\end{proof}

%We will sketch here that the inductive definition of $\SN$ and $\SNe$ is sound and complete with respect to our informal understanding of strongly normalizing reductions (Def. \ref{def:norm}).

% We will write $M \in \csn$ for $M$ is strongly normalizing in our ``informal definition'', i.e. all reduction sequences starting in $M$ are finite, to distinguish it from our inductive definition in Figure \ref{fig:sn}.

\subsection{Soundness (Short alternative proof)}

We first define $\redsn$ (strong head reduction):


  \[
\begin{array}{l}
\infer{\Gamma \vdash (\lambda x.M)\;N \redsn [N/x]M : B}{\Gamma, x{:}A \vdash M : B \quad \Gamma \vdash N : A \in \csn }
\qquad
\infer{\Gamma \vdash M\;N \redsn M'\;N : B}{\Gamma \vdash M \redsn M' : A \arrow B \quad \Gamma \vdash N : A} %  M\,\textis not a%}\;\lambda %  %& s \in \csn
  \\[1em]
\end{array}
\]

It satisfies a few  key properties:

% \begin{lemma}\label{lm:redsnred}
% If $\Gamma \vdash M \redsn N : B$ then $\Gamma \vdash M \red N : B$.
% \end{lemma}
% \begin{proof}
% Induction on the first derivation.  
% \end{proof}

\begin{lemma}\label{lm:bclosed}
If $\Gamma \vdash N : A \in \csn$ and $\Gamma \vdash [N/x]M : B \in \csn$ 
then $\Gamma \vdash (\lambda x{:}A.M)~N : B \in \csn$. 
\end{lemma}
\begin{proof}
The proof follows from the closure properties (Lemma \ref{lem:appsnclosure}) using the empty evaluation context. We prove it here directly as the generalization to evaluation contexts is not needed.
\\[1em]
Proof by induction -- either $\Gamma, x{:}A \vdash M : B \in \csn$ is getting smaller,  
$\Gamma \vdash N : A \in \csn$ is getting smaller, or 
$\Gamma \vdash [N/x]M : B \in \SN$  is getting smaller.

Assume  $\Gamma \vdash (\lambda x.M)~N \red P : B'$.

\paragraph{Case} 
  $\D = \ianc {\Gamma \vdash \lambda x{:}A.M : A \arrow B 
         \quad \Gamma \vdash  N : A}
              {\Gamma \vdash (\lambda x{:}A.M)~N  \red [N/x]M : B }{}$ and $ Q = [N/x]M$
 \\
$\Gamma \vdash [N/x]M : B \in \csn$ \hfill by assumption

\paragraph{Case}
 $\D = \ianc {\ianc{\Gamma, x{:}A \vdash M \red M' : B}
                   {\Gamma \vdash \lambda x{:}A.M \red \lambda x{:}A.M' : A \arrow B }{}
        \quad \Gamma \vdash N : A}
             {\Gamma \vdash (\lambda x{:}A.M)~N \red (\lambda x{:}A.M')~N : B}{}$ 
 and $Q = (\lambda x{:}A.M')~N$
\\[0.5em]
$\Gamma, x{:}A \vdash M' : B \in \csn$ \hfill using $\Gamma, x{:}A \vdash M : B \in \csn$\\
$\Gamma \vdash N : A \in \csn$ \hfill by assumption \\
% $\Gamma, x{:}A \vdash C[x] : B' \in \csn$ \hfill by assumption \\
$\Gamma \vdash [N/x]M \red [N/x]M' : B$ \hfill by Subst. Lemma for Typed Red\\
$\Gamma \vdash [N/x]M : B' \in \csn$ \hfill by using $\Gamma \vdash [N/x]M : B' \in \csn$ \\
$\Gamma \vdash (\lambda x{:}A.M')~N : B$ \hfill by IH (since $\Gamma \vdash [N/x]M' : B \in \csn$ is smaller)

\paragraph{Case}
 $\D = \ianc {\Gamma \vdash \lambda x{:}A.M : A \arrow B 
        \quad \Gamma \vdash N \red N' : A}
             {\Gamma \vdash (\lambda x{:}A.M)~N \red (\lambda x{:}A.M)~N' : B}{}$
\\[0.5em]
$\Gamma \vdash N' : A \in \csn$ \hfill using $\Gamma \vdash N : A \in \csn$\\
$\Gamma \vdash \lambda x{:}A.M : A \arrow B$ \hfill by assumption \\
$\Gamma, x{:}A \vdash M : B $ \hfill by inversion on typing\\
$\C : \Gamma \vdash [N/x]M \mred [N'/x]M : B$ and $1 \leq \C$ \hfill by Lemma \ref{lm:mredprop}(\ref{lm:mredsubs}) using $\Gamma \vdash N \red N' : A$\\
% $\Gamma \vdash [N/x]M \red Q : B$ and $\Gamma \vdash Q \mred [N'/x]M : B$ \hfill since $\C \geq 1$ and multi-step red.\\
$\Gamma \vdash [N'/x]M : B' \in \csn$ \hfill Lemma \ref{lm:mredsn} using $\Gamma \vdash [N/x]M : B' \in \csn$\\
$\Gamma, x{:}A \vdash M : B \in \csn$ \hfill by assumption \\
$\Gamma \vdash (\lambda x{:}A.M)~N' : B' \in \csn$ \hfill by IH  (since $\Gamma \vdash N' : A \in \csn$ is smaller)
  
\end{proof}




\begin{lemma}[Confluence $\csn$]\label{lm:confsn}$\;$
If $\Gamma \vdash M \redsn N : A$ and $\Gamma \vdash M \red N' : A$
  then either $N = N'$ or 
  there $\exists Q$ s.t. $\Gamma \vdash N'  \redsn Q : A$
        and $\Gamma \vdash N \mred Q$.
\end{lemma}
\begin{proof}
By induction on    $\Gamma \vdash M \redsn N : A$.

\paragraph{Case}
$\D = \ianc{\Gamma \vdash N : A \in \csn \quad \Gamma, x{:}A \vdash M : B}{\Gamma \vdash (\lambda x.M)\;N \redsn [N/x]M : B}{}$
\qquad
$\ianc{\Gamma \vdash \lambda x{:}A.M : A \arrow B \quad \Gamma \vdash  N : A}
      {\Gamma \vdash (\lambda x{:}A.M)~N  \red [N/x]M : B }{}$
\\[1em]
$[N/x]M : B = [N/x]M : B $ \hfill by reflexivity

\paragraph{Case}
$\D = \ianc{\Gamma \vdash N : A \in \csn \quad \Gamma, x{:}A \vdash M : B}{\Gamma \vdash (\lambda x.M)\;N \redsn [N/x]M : B}{}$
\qquad
$\ianc {\Gamma \vdash \lambda x{:}A.M \red \lambda x{:}A.M' : A \arrow B \quad \Gamma \vdash N : A}
       {\Gamma \vdash (\lambda x{:}A.M)~N  \red (\lambda x{:}A.M')~N : B}{}$
\\[0.5em]
$\Gamma, x{:}A \vdash M \red M' : B$ \hfill by inversion \\[0.5em]
WE SHOW: there exists a $Q$ s.t. $\Gamma \vdash (\lambda x{:}A.M')~N  \redsn Q : B$ and 
                                 $\Gamma \vdash [N/x]M \mred Q : B$
\\[0.5em]
Let $Q = [N/x]M'$.  \\
$\Gamma \vdash (\lambda x{:}A.M')~N \redsn [N/x]M' : B$ \hfill by def. of $\redsn$\\
$\Gamma \vdash [N/x]M \red [N/x]M' : B$ \hfill by Subst. of typed red. (Lemma \ref{lem:redsubst})\\
$\Gamma \vdash [N/x]M \mred [N/x]M' : B$ \hfill using def. of $\mred$ 

\paragraph{Case}
$\D = \ianc{\Gamma \vdash N : A \in \csn \quad \Gamma, x{:}A \vdash M : B}{\Gamma \vdash (\lambda x.M)\;N \redsn [N/x]M : B}{}$
\qquad
$\ianc {\Gamma \vdash N\red N' : A  \quad \Gamma \vdash \lambda x{:}A.M : A \arrow B}
       {\Gamma \vdash (\lambda x{:}A.M)~N  \red (\lambda x{:}A.M)~N' : B }{}$
\\[1em]
WE SHOW: there exists a $Q$ s.t. $\Gamma \vdash (\lambda x{:}A.M)~N' \redsn Q : B$ and $\Gamma \vdash  [N/x]M \mred Q : B$\\[0.5em]
Let $Q = [N'/x]M$.\\
$\Gamma \vdash (\lambda x{:}A.M)~N' \redsn [N'/x]M : B$ \hfill by def. of $\redsn$\\
$\Gamma \vdash [N/x]M \mred [N'/x]M : B $ \hfill by Lemma \ref{lm:mredprop}(\ref{lm:mredsubs}) with $\Gamma \vdash N\red N' : A$ and $\Gamma, x{:}A \vdash M : B$

\paragraph{Case}
$\D  = \ianc{\Gamma \vdash M \redsn M_1 : A \arrow B \quad \Gamma \vdash N : A}
            {\Gamma \vdash M\;N \redsn M_1\;N : B}{}$ 
\qquad
$\ianc {\Gamma \vdash M \red M_2 : A \arrow B \quad \Gamma \vdash N : A}
       {\Gamma \vdash M~N  \red M_2~N : B}{}$
\\[1em]
Either $M_2 = M_1$ or there exists a $P$ s.t. $\Gamma \vdash M_2 \redsn P : A \arrow B$ and $\Gamma \vdash M_1 \mred P : A \arrow B$ \hfill by IH 

\paragraph{Sub-case}$M_2 = M_1$
\\[0.5em]
$M_1~N = M_2~N$ \hfill trivial


\paragraph{Sub-case} there exists a $P$ s.t. $\Gamma \vdash M_2 \redsn P : A \arrow B$ and $\Gamma \vdash M_1 \mred P : A \arrow B$\\[1em]
WE SHOW: there exists a $Q$ s.t. $\Gamma \vdash M_2~N \redsn Q : B$ and $\Gamma \vdash  M_1\;N \mred Q : B$
\\[0.5em]
Let $Q = P~N$\\[0.5em]
$\Gamma \vdash M_2~N \redsn P~N : B$ \hfill using def. of $\redsn$ and $\Gamma \vdash M_2 \redsn P : A \arrow B$\\
$\Gamma \vdash M_1\;N \mred P~N : B$ \hfill using Lemma \ref{lm:mredprop} (\ref{lm:mredappl}) on multi-step red. and $\Gamma \vdash M_1 \mred P : A \arrow B$



\paragraph{Case}
$\D  = \ianc{\Gamma \vdash M \redsn M' : A \arrow B \quad \Gamma \vdash N : A}
            {\Gamma \vdash M\;N \redsn M'\;N : B}{}$ 
\qquad
$\ianc {\Gamma \vdash N\red N' : A  \quad \Gamma \vdash M : A \arrow B}
       {\Gamma \vdash M~N  \red M~N' : B }{}$
\\[1em]
WE SHOW: there exists a $Q$ s.t. $\Gamma \vdash M~N' \redsn Q : B$ and $\Gamma \vdash M'\;N \mred Q : B$
\\[0.5em]
Let $Q = M'~N'$ \\[0.5em]
$\Gamma \vdash M~N' \redsn M'~N' : B$ \hfill by $\Gamma \vdash M \redsn M' : A \arrow B$ \\
$\Gamma \vdash \vdash N\mred N' : A$ \hfill by rule for $\mred$\\
$\Gamma \vdash M'~N \mred M'~N' : B$ \hfill by Multi-Step Reduction (Lemma \ref{lm:mredprop})(\ref{lm:mredappr}))

\end{proof}



\begin{lemma}[Backward closure of $\csn$]\label{lm:backclosn}$\;$
\\
 If $\Gamma \vdash M \redsn M' : A$ and $\Gamma \vdash M' : A \in \csn$ then
     $\Gamma \vdash M : A \in \csn$.
\end{lemma}
\begin{proof}
By induction on    $\Gamma \vdash M \redsn M' : A$.

\paragraph{Case}
$\D = \ianc{\Gamma \vdash N : A \in \csn \quad \Gamma, x{:}A \vdash M : B}{\Gamma \vdash (\lambda x.M)\;N \redsn [N/x]M : B}{}$
\\[1em]
$\Gamma \vdash  [N/x]M : B \in \csn$ \hfill by assumption \\
$\Gamma \vdash N : A \in \csn $ \hfill by assumption \\
$\Gamma \vdash (\lambda x{:}A.M)~N : B \in \csn$ \hfill by Lemma \ref{lm:bclosed}


\paragraph{Case}
$\D = \ianc{\Gamma \vdash M \redsn M' : A \arrow B \quad \Gamma \vdash N : A}{\Gamma \vdash M\,N \redsn M'\,N : B}{}$
\\[1em]
$\Gamma \vdash M'~N : B \in \csn$ \hfill by assumption \\
$\Gamma \vdash M' : A \arrow B \in \csn$ \hfill by Lemma \ref{lem:psn}(Prop. \ref{pp6})\\
$\Gamma \vdash M : A \arrow B \in \csn$ \hfill by IH \\[0.5em]
Assume $\Gamma \vdash M~N \red Q : B$ \\
Either $Q = M'~N$ or $\exists P$ s.t. $\Gamma \vdash Q \redsn P : B$ and $\Gamma \vdash M'~N \mred P : B$ where we take at least one step (i.e. $P \not = M'~N$) \hfill by Conf. Lemma \ref{lm:confsn} 

\paragraph{Sub-case} $Q = M'~N$ \\
$\Gamma \vdash Q : B \in \csn$ \hfill by assumption $\Gamma \vdash M'~N : B \in \csn$
% TO SHOW $\Gamma \vdash Q : B \in \csn$

{\color{red}{\paragraph{Sub-case} $\exists P$ s.t. $\Gamma \vdash Q \redsn P : B$ and $\Gamma \vdash M'~N \mred P : B$\\[0.5em]
$\C : \Gamma \vdash P : B \in \csn$ and $\C < \D$ \hfill using $\D : \Gamma \vdash M'~N : B \in \csn$ and Lemma \ref{lm:mredsn}
\\
$\Gamma \vdash Q : B \in \csn$  \hfill by IH using $\C : \Gamma \vdash P : B \in \csn$ and $\Gamma \vdash Q \redsn P : B$
}}



\end{proof}


\begin{theorem}[Soundness of $\SN$]
\mbox{}
  \begin{enumerate}
  \item If $\Gamma \vdash M : A \in \SN$ then $\Gamma \vdash M : A \in \csn$.
  \item If $\Gamma \vdash C[x] : A \in \SNe$ then $\Gamma \vdash C[x] : A \in \csn$.
   \item If $\Gamma \vdash M \redSN M' : A$ then
           $\Gamma \vdash M \redsn M' : A$.
  \end{enumerate}
\end{theorem}
\begin{proof}
By mutual structural induction on the given derivations using the
closure properties. \\[1em]
\noindent
\fbox{1. If $\Gamma \vdash M : A \in \SN$ then $\Gamma \vdash M : A \in \csn$.}

\paragraph{Case} $\D = \ianc{\Gamma \vdash R : A \in \SNe}{\Gamma \vdash R : A \in \SN}{}$
\\[1em]
$R = C[x] $ \hfill since $\Gamma \vdash R : A \in \SNe$ \\
$\Gamma \vdash R : A \in \csn$ \hfill by IH(1)

\paragraph{Case} $\D = \ianc{\Gamma, x{:}A \vdash M : B \in \SN}
                           {\Gamma  \vdash \lambda x{:}A.M  : A \arrow B \in \SN}{}$
\\[1em]
$\Gamma, x{:}A \vdash M : B \in \csn$ \hfill by IH(1) \\
$\Gamma \vdash \lambda x{:}A.M : A \arrow B \in \csn$ \hfill by  Property \ref{lem:psn}(\ref{pp4})

\paragraph{Case} $\D = \ibnc{\Gamma \vdash M \redSN M' : A}{
                             \Gamma \vdash M' : A \in \SN}
                            {\Gamma \vdash M  : A \in \SN}{} $
\\[1em]
$\Gamma \vdash M' : A \in \csn$ \hfill by IH(1)\\
$\Gamma \vdash M : A \in \csn$ \hfill by IH (3) using the empty evaluation context and Lemma \ref{lm:closn}(\ref{cp2})
% $\Gamma \vdash M \redsn M' : A$ \hfill by IH(3)\\
% {\color{red}{$\Gamma \vdash M  : A \in \csn$ \hfill by Closure Property \ref{lm:closn}(\ref{cp5}) -- should be proven differently without using $\redsn$}}
\\[1em]
\noindent
\fbox{2. If $\Gamma \vdash C[x] : A \in \SNe$ then $\Gamma \vdash C[x] : A \in \csn$.}

\paragraph{Case} $\D = \ianc{x{:}A \in \Gamma}{\Gamma \vdash x : A \in \SNe}{}$
\\[1em]
$C = \_ $ \hfill since $C[x] = x$\\
$\forall M'.~\Gamma \vdash x \red M' : A \imply \Gamma \vdash M' : A \in \csn$ \hfill since $\Gamma \vdash x \red M' : A$ is impossible
\\
$\Gamma \vdash x \in \csn$

\paragraph{Case}$\D = \ibnc{\Gamma \vdash R : A \arrow B \in \SNe}{\Gamma \vdash M : A \in \SN}{\Gamma \vdash R\,M : B \in \SNe}{}$
\\
$C'[x] = R$ \hfill since $C[x] = R\;M$\\
$\Gamma \vdash C'[x] : A \arrow B\in \csn$ \hfill by IH(2) \\
$\Gamma \vdash M : A \in \csn$ \hfill by IH(1)\\
$\Gamma \vdash C'[x]\;M : B \in \csn$ \hfill by Closure Property \ref{lm:closn}(\ref{cp3})\\
$\Gamma \vdash C[x] : A \arrow B \in \csn$ \hfill since $C[x] = C'[x]~M$
\\[1em]

\fbox{3. If $\Gamma \vdash M \redSN M' : A$ then
           $\Gamma \vdash M \redsn M' : A$.}

Induction on $\Gamma \vdash M \redSN M' : A$ 

\paragraph{Case}
$\D = \ianc{\Gamma \vdash N : A \in \SN \quad \Gamma, x{:}A \vdash M : B}{\Gamma \vdash (\lambda x.M)\;N \redSN [N/x]M : B}{}$
\\[1em]
$\Gamma \vdash N : A \in \csn$ \hfill by IH (1)\\
$\Gamma \vdash (\lambda x.M)\;N \redsn [N/x]M : B$ \hfill by def. of $\redsn$

\paragraph{Case}
$\D = \ianc{\Gamma \vdash R \redSN R' : A \arrow B \quad \Gamma \vdash M : A}{\Gamma \vdash R\,M \redSN R'\,M : B}{}$
\\[1em]
$\Gamma \vdash R \redsn R' : A \arrow B$ \hfill by IH(3) \\
$\Gamma \vdash  R\,M \redsn R'\,M : B$ \hfill by def. of $\redsn$
\end{proof}


\subsection{Soundness and Completeness}
We can now prove that the two definitions of strongly normalizing terms coincide (soundness and completeness).
For proving normalization, soundness of the inductive definition of $\SN$ suffices.



\begin{theorem}[Soundness of $\SN$]
\mbox{}
  \begin{enumerate}
  \item If $\Gamma \vdash M : A \in \SN$ then $\Gamma \vdash M : A \in \csn$.
  \item If $\Gamma \vdash C[x] : A \in \SNe$ then $\Gamma \vdash C[x] : A \in \csn$.
  \item \label{lem:SNsn}
        If   $\Gamma \vdash M \redSN M_1 : A$ and $\Gamma \vdash C[M_1] : A_0 \in \SN$ and 
             $\Gamma \vdash C[M_1] : A_0 \in \csn$ and $\Gamma \vdash C[M] \red Q$ and 
             $\Gamma, x{:}A \vdash C[x] : B' \in \csn$
        then $\Gamma \vdash Q : A_0 \in \csn$.  
%   \item If $\Gamma \vdash M \redSN M' : A$ then
%           $\Gamma \vdash M \redsn M' : A$.
  \end{enumerate}
\end{theorem}
\begin{proof}
By mutual structural induction on the given derivations using the
closure properties. \\[1em]
\noindent
\fbox{1. If $\Gamma \vdash M : A \in \SN$ then $\Gamma \vdash M : A \in \csn$.}

\paragraph{Case} $\D = \ianc{\Gamma \vdash R : A \in \SNe}{\Gamma \vdash R : A \in \SN}{}$
\\[1em]
$R = C[x] $ \hfill since $\Gamma \vdash R : A \in \SNe$ \\
$\Gamma \vdash R : A \in \csn$ \hfill by IH(1)

\paragraph{Case} $\D = \ianc{\Gamma, x{:}A \vdash M : B \in \SN}
                           {\Gamma  \vdash \lambda x{:}A.M  : A \arrow B \in \SN}{}$
\\[1em]
$\Gamma, x{:}A \vdash M : B \in \csn$ \hfill by IH(1) \\
$\Gamma \vdash \lambda x{:}A.M : A \arrow B \in \csn$ \hfill by  Property \ref{lem:psn}(\ref{pp4})

\paragraph{Case} $\D = \ibnc{\Gamma \vdash M \redSN M' : A}{
                             \Gamma \vdash M' : A \in \SN}
                            {\Gamma \vdash M  : A \in \SN}{} $
\\[1em]
$\Gamma \vdash M' : A \in \csn$ \hfill by IH(1)\\
$\Gamma \vdash M : A \in \csn$ \hfill by IH (3) using the empty evaluation context and Lemma \ref{lm:closn}(\ref{cp2})
% $\Gamma \vdash M \redsn M' : A$ \hfill by IH(3)\\
% {\color{red}{$\Gamma \vdash M  : A \in \csn$ \hfill by Closure Property \ref{lm:closn}(\ref{cp5}) -- should be proven differently without using $\redsn$}}
\\[1em]
\noindent
\fbox{2. If $\Gamma \vdash C[x] : A \in \SNe$ then $\Gamma \vdash C[x] : A \in \csn$.}

\paragraph{Case} $\D = \ianc{x{:}A \in \Gamma}{\Gamma \vdash x : A \in \SNe}{}$
\\[1em]
$C = \_ $ \hfill since $C[x] = x$\\
$\forall M'.~\Gamma \vdash x \red M' : A \imply \Gamma \vdash M' : A \in \csn$ \hfill since $\Gamma \vdash x \red M' : A$ is impossible
\\
$\Gamma \vdash x \in \csn$

\paragraph{Case}$\D = \ibnc{\Gamma \vdash R : A \arrow B \in \SNe}{\Gamma \vdash M : A \in \SN}{\Gamma \vdash R\,M : B \in \SNe}{}$
\\
$C'[x] = R$ \hfill since $C[x] = R\;M$\\
$\Gamma \vdash C'[x] : A \arrow B\in \csn$ \hfill by IH(2) \\
$\Gamma \vdash M : A \in \csn$ \hfill by IH(1)\\
$\Gamma \vdash C'[x]\;M : B \in \csn$ \hfill by Closure Property \ref{lm:closn}(\ref{cp3})\\
$\Gamma \vdash C[x] : A \arrow B \in \csn$ \hfill since $C[x] = C'[x]~M$
\\[1em]
\noindent
\fbox{
  \begin{tabular}{p{15cm}}
3. If   $\Gamma \vdash M \redSN M_1 : A$ and $\Gamma \vdash C[M_1] : A_0 \in \SN$ and 
        $\Gamma \vdash C[M_1] : A_0 \in \csn$ and $\Gamma \vdash C[M] \red Q$ 
        \quad and $\Gamma, x{:}A \vdash C[x] : A_0 \in \csn$ \\
   then $\Gamma \vdash Q : A_0 \in \csn$.
  \end{tabular}
}
\\[1em]
\noindent
Recall that $C[M_1] = \underline{M_1}~N_1 \ldots N_n$ where $C = \_~N_1 \ldots N_n$.
Moreover, we have 

\[
\ianc{\Gamma \vdash M \red M' : A}{\Gamma \vdash C[M] \red C[M'] : A'}{}
\]


\paragraph{Case} $\ianc{\Gamma \vdash N : A \in \SN \quad \Gamma, x{:}A \vdash M : B}
                       {\Gamma \vdash (\lambda x.M)\;N \redSN [N/x]M : B}{}$ 
            \qquad and \qquad$
            \ianc{
                  \ianc{\Gamma \vdash \lambda x{:}A.M : A \arrow B \quad \Gamma \vdash  N : A}
                       {\Gamma \vdash (\lambda x.M)\;N \red [N/x]M : B}{}}
                 {\Gamma \vdash C[\,(\lambda x.M)\;N\,] \red C[\,[N/x]M\,] : B'}{}
                $
\\[1em]
$\Gamma \vdash C[\,[N/x]M\,]:B' \in \csn$ \hfill by assumption (and $M_1 = M_2$)

\paragraph{Case} $\ianc{\Gamma \vdash N : A \in \SN \quad \Gamma, x{:}A \vdash M : B}
                       {\Gamma \vdash (\lambda x.M)\;N \redSN [N/x]M : B}{}$
\qquad and \qquad$
             \ianc{
                   \ibnc{\Gamma \vdash \lambda x.M \red \lambda x.M' : A \arrow B}
                        {\Gamma \vdash N : A}
                        {\Gamma \vdash (\lambda x.M)~N \red (\lambda x.M')~N : B}{}}
                     {\Gamma \vdash C[\,(\lambda x.M)\;N\,] \red C[\, (\lambda x.M')~N \,] : B'}{}
                  $
\\[1em]
$\Gamma, x:A \vdash M \red M' : B$ \hfill by inversion on $\red$\\
$\Gamma \vdash C[\,[N/x]M\,] : B' \in \SN$ \hfill by assumption \\
$\Gamma \vdash C[\,[N/x]M\,] : B' \in \csn$ \hfill by assumption \\
$\Gamma \vdash [N/x]M : B \in \csn$ \hfill by Lemma \ref{lem:psn}(\ref{pp6}) (iterated)\\
$\Gamma \vdash N : A$ \hfill by assumption \\
$\Gamma,x{:}A \vdash M : B \in \csn$ \hfill by Lemma \ref{lem:psn}(\ref{pp3}) \\
$\Gamma, x{:}A \vdash M' : B \in \csn$ \hfill using $\Gamma,x{:}A \vdash M : B \in \csn$ \\
$\Gamma \vdash N : A \in \csn$ \hfill by IH (1) using $\Gamma \vdash N : A \in \SN$\\
$\Gamma \vdash [N/x]M \red [N/x]M' : B$ \hfill by Lemma (Subst. Red) \ref{lem:redsubst}\\
$\Gamma \vdash C[~[N/x]M'~]  \red C[~[N/x]M'~] : B' \in \csn$ \hfill using eval. ctx. red.\\
$\Gamma \vdash C[~[N/x]M'~]: B' \in \csn $ \hfill using $\Gamma \vdash C[\,[N/x]M\,] : B' \in \csn$\\
$\Gamma, x{:}A \vdash C[x] : B' \in \csn$ \hfill by asumption \\
$\Gamma \vdash C[(\lambda x.M')~N] : B' \in \csn$ \hfill by Lemma \ref{lem:appsnclosure}

\paragraph{Case} $\ianc{\Gamma \vdash N : A \in \SN \quad \Gamma, x{:}A \vdash M : B}
                       {\Gamma \vdash (\lambda x.M)\;N \redSN [N/x]M : B}{}$
\qquad and \qquad$
             \ianc{     
                   \ianc{\Gamma \vdash \lambda x.M : A \arrow B \quad \Gamma \vdash N \red N' : A}
                        {\Gamma \vdash (\lambda x.M)~N \red (\lambda x.M)~N' : B}{}}
                  {\Gamma \vdash C[\,(\lambda x.M)\;N\,] \red C[\, (\lambda x.M)~N' \,] : B'}{}
$
\\[1em]
$\Gamma \vdash C[\,[N/x]M\,] : B' \in \SN$ \hfill by assumption \\
$\Gamma \vdash C[\,[N/x]M\,] : B' \in \csn$ \hfill by assumption \\
$\Gamma \vdash N : A \in \csn$ \hfill by IH(1) using $\Gamma \vdash N : A \in \SN$\\
$\Gamma \vdash N' : A \in \csn$ \hfill using previous line and $\Gamma \vdash N \red N' : A$\\
$\Gamma \vdash [N/x]M : B \in \csn$ \hfill by  Lemma \ref{lem:psn}(\ref{pp6}) (iterated)\\
$\Gamma \vdash N : A$ \hfill by assumption \\
$\Gamma,x{:}A \vdash M : B \in \csn$ \hfill by Lemma \ref{lem:psn}(\ref{pp3}) \\ 
$\Gamma, x{:}A \vdash C[x] : B' \in \csn$ \hfill by assumption \\
$\Gamma, x{:}A \vdash M : B $ \hfill by inversion on typing\\
$\Gamma \vdash [N/x]M \mred [N'/x]M : B$ \hfill by Lemma \ref{lm:mredprop}(\ref{lm:mredsubs}) using $\Gamma \vdash N \red N' : A$\\
$\Gamma \vdash [N'/x]M : B \in \csn$ \hfill  Lemma \ref{lm:mredsn} using $\Gamma \vdash [N/x]M : B \in \csn$\\
$\Gamma \vdash C[\,(\lambda x.M)~N'\,] : B' \in \csn$ \hfill by Lemma \ref{lem:appsnclosure}

%
\paragraph{Case} $\ianc{\Gamma \vdash R \redSN M' : A \arrow B \quad
  \Gamma \vdash N : A}{\Gamma \vdash R\,N \redSN M'\,N : B}{}$
\quad and \quad  $
           \ianc{
                 \ianc{\Gamma \vdash R \red M'' : A \arrow B \quad \Gamma \vdash N : A}
                      {\Gamma \vdash R~N \red M''~N: B}{}}
                {\Gamma \vdash C[\,R~N\,] \red C[\,M''~N\,] : B'}{}      
$\\[0.5em]
                      where $R$ is not a $\lambda$-abstraction
\\[1em]
$C[\,R~N\,] = \underline{(R~N)}~N_1 \ldots N_n$ and $C = \underline{\quad} ~N_1 \ldots N_n$ \\
Let $C' = \underline{\quad}~ N~N_1 \ldots N_n$ and hence $C[\,R~N\,] = C'[R]$.
\\[0.5em]
% {\color{red}{TO SHOW: $\Gamma \vdash M''~N:B \in \csn$}} \\
$\Gamma \vdash C[\,M'\,N\,] : B' \in \SN$ \hfill by assumption \\ 
$\Gamma \vdash C'[M'] : B' \in \SN$ \hfill using $C'[R] = C[\,R~N\,]$.\\
% $\Gamma \vdash M' : A \rightarrow B \in \SN$ \hfill by Lemma \ref{lem:SNApp} (lifted to evalutation contexts) \\
% $\Gamma \vdash C[\,M'\,N\,] : B \in \csn$ \hfill by assumption \\
$\Gamma \vdash C'[M'] : B' \in \csn$ \hfill using $C'[R] = C[\,R~N\,]$.\\
% $\Gamma \vdash M' : A \rightarrow B \in \csn$ \hfill by Property \ref{lem:psn}(\ref{pp6}) (lifted to evaluation contexts) \\
$\Gamma \vdash R \redSN M' : A \rightarrow B$ and $\Gamma \vdash C'[R] \red C'[M''] : B'$ \hfill by assumption \\
$\Gamma,x{:}A \vdash C[x] : B' \in \csn$ \hfill by assumption \\
$\Gamma, x{:}A \arrow B \vdash x : A \arrow B \in \csn$ \hfill since variables do not reduce \\
$\Gamma, x{:}A \vdash N : A \in \csn$ \hfill using Lemma \ref{lem:psn}(Property \ref{pp6}) - iterated\\
$\Gamma, x{:}A \arrow B \vdash x~N  : B \in \csn$ \hfill using Lemma \ref{lm:closn}(Property \ref{cp3})\\
{$\Gamma, x{:}A \arrow B \vdash C[x~N] : B' \in \csn$ \hfill by composition of eval. cxt (Lemma \ref{lm:compecxt}) using $C_0[x] = x~N$ }\\
$\Gamma, x{:}A \arrow B \vdash C'[x] : B' \in \csn$ \hfill since $C'[x] = C[x~N]$ \\
$\Gamma \vdash C'[M''] : B' \in \csn$ \hfill by IH (3) \\
$\Gamma \vdash C[M''~N] : B' \in \csn$ \hfill by using $C'[R] = C[\,R~N\,]$.

\paragraph{Case} $\ianc{\Gamma \vdash R \redSN M' : A \arrow B \quad \Gamma \vdash N : A}{\Gamma \vdash R\,N \redSN M'\,N}{}$
\quad and \quad $
           \ianc{
                 \ianc{\Gamma \vdash N \red N' : A \arrow B \quad \Gamma \vdash R : A \arrow B}
                      {\Gamma \vdash R~N \red R~N' : B}{}}
                {\Gamma \vdash C[\,R~N\,] \red C[\,R~N'\,] : B'}{}
$ 
\\[0.5em] where $R$ is not a $\lambda$-abstraction
\\[1em]
$C[\,R~N\,] = \underline{(R~N)}~N_1 \ldots N_n$ and $C = \underline{\quad} ~N_1 \ldots N_n$ \\
Let $C' = \underline{\quad}~ N~N_1 \ldots N_n$ and hence $C[\,R~N\,] = C'[R]$.
\\[0.5em]
$\Gamma \vdash C[\,M'\,N\,] : B' \in \SN$ \hfill by assumption \\
$\Gamma \vdash C'[M'] : B' \in \SN$ \hfill using $C[\,M'~N\,] = C'[M']$.\\
$\Gamma \vdash C[\,M'\,N\,] : B \in \csn$ \hfill by assumption \\
$\Gamma \vdash C'[M'] : B' \in \csn$ \hfill using $C[\,M'~N\,] = C'[M']$.\\
$\Gamma \vdash C'[R] \red C[R~N']: B'$ \hfill by assumption $C'[R] = C[\,R~N\,]$\\
$\Gamma \vdash R \redSN M' : A \arrow B $ \hfill by assumption \\
$\Gamma,x{:}A \vdash C[x] : B' \in \csn$ \hfill by assumption \\
$\Gamma, x{:}A \vdash N : A \in \csn$ \hfill using Lemma \ref{lem:psn}(Property \ref{pp6}) - iterated\\
$\Gamma, x{:}A \arrow B \vdash x~N  : B \in \csn$ \hfill using Lemma \ref{lm:closn}(Property \ref{cp3})\\
$\Gamma, x{:}A \arrow B \vdash C[x~N] : B' \in \csn$ \hfill by composition of eval. cxt (Lemma \ref{lm:compecxt}) using $C_0[x] = x~N$ \\
$\Gamma, x{:}A \vdash C'[x] : B' \in \csn$ \hfill since $C'[x] = C[x~N]$ \\
$\Gamma \vdash C[\,R~N'\,]:B \in \csn$ \hfill by IH (3)


\end{proof}



\begin{theorem}[Completeness of $\SN$]\mbox{}
\begin{enumerate}
\item\label{csn1} If $\Gamma \vdash C[x] : A \in \csn$ then $\Gamma \vdash C[x] : A \in \SNe$.
%\item\label{csn2} If $\Gamma \vdash C[(\lambda x.M)~N] : A \in \csn$
%      then $\Gamma \vdash  C[(\lambda x.M)~N] \redSN  C[[N/x]M] : A$
%      and $\Gamma \vdash C[[N/x]M] : A \in \SN$.
% \item If $\Gamma \vdash M \in \csn$ and $\Gamma \vdash M \redSN M'$
%  then $\Gamma \vdash M' \in \SN$.
 \item If $\Gamma \vdash M : A \in \csn$ then $\Gamma \vdash M : A \in \SN$.
%  \item If $R = x\,\vec N \in \csn$ then $x\,\vec N\in \SNe$.
%  \item If $R = (\lambda x.M)\,N\,\vec N \in \csn$ then $R \redSN [N/x]M\,\vec  N$.
%  \item If $R \in \csn$ then $R \in \SN$.
  \end{enumerate}
\end{theorem}
\begin{proof}

\fbox{\ref{csn1}. If $\Gamma \vdash C[x] : A \in \csn$ then $\Gamma \vdash C[x] : A \in \SNe$.}
\\[1em]
By structural induction on $C[x]$.

\paragraph{Case} $C = \_$
\\[0.5em]
$\Gamma \vdash x:A$ \hfill by assumption $\Gamma \vdash x : A \in \csn$\\
$\Gamma \vdash x : A \in \SNe$ \hfill by def. of $\SNe$\\
% \footnote{Technically we should keep around explicitly that
%  $\csn$ is defined on well-typed terms, so we actually have the
%  assumption that $x{:}A$ is in $\Gamma$. }

\paragraph{Case} $C = C'~M$
\\[0.5em]
$\Gamma \vdash C'[x]~M : B \in \csn$ \hfill by assumption \\
$\Gamma \vdash C'[x] : A \arrow B \in \csn$ and $\Gamma \vdash M : A \in \csn$ \hfill by Lemma \ref{lem:psn} (Property \ref{pp6})\\
$\Gamma \vdash C'[x] : A \arrow B \in \SNe$ \hfill by IH(1) \\
$\Gamma \vdash M : A \in \SN$ \hfill by IH (3) \\
$\Gamma \vdash C'[x]~M : B \in \SNe $ \hfill by def. of $\SNe$
\\[1em]
% \fbox{\ref{csn2}. If $\Gamma \vdash C[(\lambda x{:}A.M)~N] : B \in \csn$
%       then $\Gamma \vdash  C[(\lambda x{:}A.M)~N] \redSN  C[[N/x]M] : B$ and $\Gamma \vdash C[[N/x]M] : B \in \SN$. }
% \\[0.5em]
% By structural induction on $C[(\lambda x.M)~N]$. We again leave some of the reasoning about well-typed terms implicit.

% \paragraph{Case} $C = \_$
% \\[0.5em]
% $\Gamma \vdash (\lambda x{:}A.M)~N : B \in \csn$ \hfill by assumption \\
% $\Gamma \vdash \lambda x{:}A.M : A \arrow B\in \csn$ and $\Gamma \vdash N  : A \in \csn$\hfill by Lemma
% \ref{lem:psn}(Property \ref{pp6})\\
% $\Gamma \vdash N : A \in \SN$ \hfill by IH (3) \\
% $\Gamma \vdash \lambda x{:}A.M : A \arrow B \in \SN$ \hfill by IH (3)\\
% $\Gamma, x{:}A \vdash M : B \in \SN$ \hfill by def. of $\SN$\\
% $\Gamma \vdash [N/x]M : B \in \SN$ \hfill by subst. lemma \ref{lem:SNsubst}\\
% $\Gamma \vdash (\lambda x{:}A.M)~N \redSN [N/x]M : B$ \hfill by def. of $\redSN$

% \paragraph{Case} $C = C'~M'$
% \\[0.5em]
% $\Gamma \vdash C'[(\lambda x{:}A.M)~N]~M' : B\in \csn$ \hfill by assumption
% \\
% $\Gamma \vdash C'[(\lambda x{:}A.M)~N] : B' \arrow B \in \csn$ and $\Gamma \vdash M' : B'\in \csn$ \hfill by Lemma \ref{lem:psn}(Property \ref{pp6})\\
% $\Gamma \vdash N : A \in \csn$ \hfill by Lemma \ref{lem:psn}(Property \ref{pp6}) (iterated)\\
% $\Gamma \vdash C'[(\lambda x{:}A.M)~N] \redSN  C'[[N/x]M] : B' \arrow B$ and $\Gamma \vdash C'[[N/x]M] : B' \arrow B \in \SN$ \hfill by IH (2)\\
% $\Gamma \vdash C'[(\lambda x{:}A.M)~N]~M' : B \redSN  C'[[N/x]M]~M' : B$ \hfill by def. $\redSN$\\
% $\Gamma \vdash M' : B'\in \SN$ \hfill by IH (3) \\
% {\color{red}{$\Gamma \vdash  C'[[N/x]M]~M' : B \in \SN$ \hfill by Closure property (Lemma \ref{lm:pSN0})}}
% \\[1em]
\noindent
\fbox{2. If $\Gamma \vdash M : A \in \csn$ then $\Gamma \vdash M : A \in \SN$.}
\\[1em]
Induction on $M$.

\paragraph{Case} $M = x$ where $x{:}A \in \Gamma$.
\\[1em]
$\Gamma \vdash x : A \in \SNe$ \hfill by def. of $\SNe$\\
$\Gamma \vdash x : A \in \SN$ \hfill by def. of $\SN$.

\paragraph{Case} $M = \lambda x{:}A.M'$
\\[1em]
$\Gamma \vdash \lambda x{:}A.M' : A \arrow B \in \csn$ \hfill by assumption\\
$\Gamma, x{:}A \vdash M' : B\in \csn$ \hfill by Lemma \ref{lem:psn} (Property \ref{pp7})\\
$\Gamma, x{:}A \vdash M' : B \in \SN$ \hfill by IH (2)\\
$\Gamma \vdash \lambda x{:}A.M' : A \arrow B \in \SN$ \hfill  by def. of $\SN$

\paragraph{Case} $M = M_1~M_2$
\\[1em]
$\Gamma \vdash M_1~M_2 : B \in \csn$ \hfill by assumption\\
%$\Gamma \vdash M_1 : A \arrow B \in \csn$ and $\Gamma \vdash M_2 : A \in \csn$ \hfill by Lemma \ref{lem:psn} (Property \ref{pp6})
\\[0.5em]
 \textbf{Sub-case:} $C[x] = M_1~M_2$ \\[0.5em]
 $\Gamma \vdash M_1~M_2 : B \in \SNe$ \hfill by IH (1) (this is valid,
 since (1) is strictly decreasing when we refer to (3))\\
 $\Gamma \vdash M_1~M_2 : B \in \SN$ \hfill by def. of $\SN$
 \\[1em]
 \textbf{Sub-case:} $C[(\lambda x.M)~N] = M_1~M_2$ \\[0.5em]
$\Gamma \vdash C[(\lambda x.M)~N] : B \in \csn$ \hfill by assumption \\
$\Gamma \vdash (\lambda x.M)~N \red [N/x]M : B'$ \hfill by reduction rule \\
$\Gamma \vdash C[(\lambda x.M)~N] \red C[~[N/x]M~] : B$ \hfill by eval. ctx. rule\\
$\Gamma \vdash C[~[N/x]M~] : B \in \csn$ \hfill using $\Gamma \vdash C[(\lambda x.M)~N] : B \in \csn$ \\
$\Gamma \vdash  C[~[N/x]M~] : B \in \SN$ \hfill by IH (2)\\
$\Gamma \vdash C[(\lambda x.M)~N] \redSN  C[~[N/x]M~] : B$ \hfill iterating over $\redSN$\\
$\Gamma \vdash C[(\lambda x.M)~N] : B \in \SN$ \hfill using $\SN$.

\end{proof}


\section{Reducibility Candidates}
One might ask, what is a good definition of a semantic type? - Rather than
attempting the proof of the fundamental lemma directly and then trying to
extract additional lemmas one might need about the semantic types, we follow
Girard's technique and characterize some key properties our semantic types need
to satisfy. If a semantic type satisfies these key properties, then our proof of the fundamental lemma will be straightforward. To put it differently, defining these key properties, will allow for a  a modular proof of the fundamental lemma.

% \begin{definition}[Reducibility Candidate] $\Gamma \vdash M \in \den{A}$ is a reducibility
%   candidate, if the following conditions hold
%   \begin{itemize}
%   \item $\CR 1:$ If $\Gamma \vdash M \in \den{A}$ then $M \in \SN$. % , i.e. $\den{A} \subseteq \SN$.% \\[0.5em]
%   \item $\CR 2:$ If $\Gamma \vdash M \in \SNe$ then $\Gamma \vdash M \in \den{A}$. % , i.e. $\SNe \subseteq \den{A}$. % \\[0.5em]
%   \item $\CR 3:$ If $\Gamma \vdash M \redSN M'$ and $\Gamma \vdash M' \in \den{A}$ then $\Gamma \vdash M \in \den{A}$, i.e . $\den{A}$ is closed under reduction.
%   \end{itemize}
% \end{definition}

% The last property is often also referred to as \emph{backward closed}. We show that that all semantic types $\den{A}$ satisfy the conditions above.



\begin{theorem}\label{thm:redcand}~
% For all types $C$, $\Gamma \vdash M \den{C}  \in \CR$, i.e. it satisfies the conditions $\CR_1$, $\CR_2$, and $\CR_3$.
  \begin{enumerate}
  \item\label{cr1} \CR 1: If $\inden{\Gamma}{M}{A}$ then $\Gamma \vdash M : A \in \SN$. % , i.e. $\den{A} \subseteq \SN$.% \\[0.5em]
  \item\label{cr2} \CR 2: If $\Gamma \vdash M : A \in \SNe$ then $\inden{\Gamma}{M}{A}$. % , i.e. $\SNe \subseteq \den{A}$. % \\[0.5em]
  \item\label{cr3} \CR 3: If $\Gamma \vdash M \redSN M' : A$ and $\inden{\Gamma}{M'}{A}$ then $\inden{\Gamma}{M}{A}$, i.e. backwards closure.
  \end{enumerate}
\end{theorem}
\begin{proof}
We prove these three properties simultaneously.
\\[1em]
\fbox{\CR \ref{cr1}.  If $\inden{\Gamma}{M}{C}$ then $\Gamma \vdash M : A \in \SN$.}
\\[0.5em]
By induction on the structure of $C$.

\paragraph{Case: $C =\base$}.\\
$\inden{\Gamma}{M}{\base}$ \hfill by assumption \\
$\Gamma \vdash M : \base \in \SN$ \hfill by def. of sem. interpretation for $\base$

\paragraph{Case: $C = A \arrow B$}.
\\
$\Gamma, x{:}A \vdash x : A \in \SNe$ \hfill by def. of $\SNe$\\
$\inden{\Gamma. x{:}A}{x}{A}$ \hfill by IH (\ref{cr2}) \\
% $\Gamma, x{:}A \models x : A$ \hfill by Lemma \ref{lm:closn} (Property \ref{cp2})\\
$\Gamma, x{:}A \ext{\id} \Gamma$ \hfill by def. of context extensions \\
% $\Gamma, x{:}A \models M  : A \arrow B$ \hfill by Semantic Weakening Lemma \ref{lm:sweak}\\
$\inden{\Gamma, x{:}A}{[\id]M~x}{B}$ \hfill by def. of  $\inden{\Gamma, x{:}A}{M}{A \arrow B}$\\
$\Gamma, x{:}A \vdash [\id]M~x : B\in \SN$ \hfill by IH (\CR \ref{cr1})\\
$\Gamma, x{:}A \vdash [\id]M : A \arrow B \in \SN$ \hfill by  Extensionality Lemma \ref{lm:pSN} \\% Lemma \ref{lem:psn} (Property \ref{pp6})\\
$\Gamma \vdash M : A \arrow B\in \SN$ \hfill by Anti-renaming Lemma \ref{lm:anti-renameSN}
\\[1em]
\fbox{\CR \ref{cr2}. If $\Gamma \vdash M : C\in \SNe$ then $\inden{\Gamma}{M}{C}$.}
\\[0.5em]
By induction on $\Gamma \vdash M : C \in \SNe$.

\paragraph{Case: $C=\base$}.\\
$\Gamma \vdash M : C \in \SNe$ \hfill by assumption \\
$\Gamma \vdash M : C \in \SN$ \hfill by def. of $\SN$\\
% $\Gamma \vdash M \hastype \base$ \hfill by assumption \\
$\inden{\Gamma}{M}{\base}$ \hfill by def. of semantic typing

\paragraph{Case: $C = A \arrow B$}.\\
Assume $\Gamma' \ext{\rho} \Gamma$ and $\inden{\Gamma'}{N}{A}$ \\
$\Gamma' \vdash N : A\in \SN$ \hfill by IH (\CR \ref{cr1}) \\
$\Gamma \vdash M : A \arrow B \in \SNe$ \hfill by assumption \\
$\Gamma' \vdash [\rho]M : A \arrow B \in \SNe$ \hfill by Renaming Lemma \ref{lm:renameSN} \\
$\Gamma' \vdash [\rho]M~N : B \in \SNe$ \hfill by def. of $\SNe$\\
$\inden{\Gamma'}{[\rho]M~N}{B}$ \hfill by IH (\CR \ref{cr2})\\
$\inden{\Gamma}{M}{A \arrow B}$ \hfill since $\inden{\Gamma'}{N}{A}$ was arbitrary
\\[1em]
\fbox{\CR \ref{cr3}.   If $\Gamma \vdash M \redSN M' : C$ and $\inden{\Gamma}{M'}{C}$ then $\inden{\Gamma}{M}{C}$}
\\[0.5em]
By induction on $C$.
\paragraph{Case: $C = \base$}.\\[0.5em]
$\Gamma \vdash M' : \base \in \SN$  \hfill since $\inden{\Gamma}{M'}{\base}$\\
$\Gamma \vdash M : \base \in \SN$ \hfill by closure rule for $\SN$\\
$\inden{\Gamma}{M}{\base}$ \hfill by definition of semantic typing

\paragraph{Case: $C = A \arrow B$}.
\\[0.5em]
Assume $\Gamma' \ext{\rho} \Gamma$,~$\inden{\Gamma'}{N}{A}$ \\
$\inden{\Gamma'}{M'[\rho]~N}{B}$ \hfill by assumption $\inden{\Gamma}{M'}{A \arrow B}$\\
$\Gamma \vdash M \redSN M' : A \arrow B$ \hfill by assumption \\
$\Gamma' \vdash [\rho]M \redSN [\rho]M' : A \arrow B$ \hfill by Renaming Lemma \ref{lm:renameSN}\\
$\Gamma' \vdash [\rho]M~N \redSN [\rho]M'~N : B$ \hfill by $\redSN$\\
$\inden{\Gamma}{[\rho]M~N}{B}$ \hfill by IH (\CR\ref{cr3})\\
$\inden{\Gamma}{M}{A \arrow B}$ \hfill since $\inden{\Gamma'}{N}{A}$ was arbitrary\\

\end{proof}


\section{Proving strong normalization}
As mentioned before, we prove that if a term is well-typed, then it is strongly normalizing in  two steps:

\begin{description}
\item[Step 1] If $\inden{\Gamma}{M}{A}$ then $\Gamma \vdash M : A \in \SN$.
\item[Step 2] If $\Gamma \vdash M : A$ and $\inden{\Gamma'}{\sigma}{\Gamma}$ then $\inden{\Gamma'}{[\sigma] M}{A}$.
\end{description}

The first part described in Step 1, is satisfied by the fact that $\inden{\Gamma}{M}{A}$ must be a reducibility candidate (Theorem \ref{thm:redcand}) and  by \CR \ref{cr1})  all terms in $\denot{A}$ are strongly normalizing. We now prove the second step, which is often referred to as the \emph{Fundamental Lemma}.
It states that if $M$ has type $A$ and we can provide ``good'' instantiation $\sigma$, which provides terms which are themselves normalizing for all the free variables in $M$, then $\inden{\Gamma}{[\sigma]M}{A}$.


\begin{lemma}[Fundamental lemma]
If $\Gamma \vdash M : A$ and $\inden{\Gamma'}{\sigma}{\Gamma}$
then $\inden{\Gamma'}{[\sigma]M}{A}$.
\end{lemma}
\begin{proof}
By induction on $\Gamma \vdash M : A$.

\paragraph{Case} $\D = \ianc{\Gamma(x) = A}{\Gamma \vdash x : A}{}$
\\[1em]
$\inden{\Gamma'}{\sigma}{\Gamma}$ \hfill by assumption \\
$\inden{\Gamma'}{[\sigma]x}{A}$ \hfill by definition of $[\sigma]x$ and $\inden{\Gamma'}{\sigma}{\Gamma}$

\paragraph{Case} $\D = \ibnc{\Gamma \vdash M : A \rightarrow B}{\Gamma \vdash N : A}{\Gamma \vdash M\;N : B}{}$
\\
$\inden{\Gamma'}{\sigma}{\Gamma}$ \hfill by assumption \\
$\inden{\Gamma'}{[\sigma]M}{A \rightarrow B}$ \hfill by IH\\
$\inden{\Gamma'}{[\sigma]N}{A}$ \hfill by IH\\
$\inden{\Gamma'}{[\sigma]M\;[\sigma]N}{B}$ \hfill by $\inden{\Gamma'}{[\sigma]M}{A \rightarrow B}$\\
$\inden{\Gamma'}{[\sigma](M\;N)}{B}$ \hfill by subst. definition \\


\paragraph{Case} $\D = \ianc{\Gamma, x:A \vdash M:B}{\Gamma \vdash \lambda x.M : A \rightarrow B}{}$
\\
$\inden{\Gamma'}{\sigma}{\Gamma}$ \hfill by assumption \\
Assume $\Gamma'' \ext{\rho} \Gamma'$ and $\Gamma'' \vdash N : A$  \\
$\inden{\Gamma''}{[\rho] \sigma}{\Gamma}$ \hfill by weakening \\
$\inden{\Gamma''}{([\rho]\sigma, N/x)}{\Gamma, x:A}$ \hfill by definition of semantic substitutions\\
$\inden{\Gamma''}{[[\rho]\sigma, N/x]M}{B}$ \hfill by IH \\
$\Gamma'' \vdash (\lambda x.[[\rho]\sigma,x/x]M)\;N \redSN [[\rho]\sigma, N/x]M$ \hfill by reduction $\redSN$ \\
$(\lambda x.[[\rho]\sigma,x/x]M) = [[\rho]\sigma](\lambda x.M)$ \hfill by subst. def\\
$\inden{\Gamma''}{([[\rho]\sigma]\lambda x.M)\;N}{B}$ \hfill by $\CR 3$ \\
$\inden{\Gamma'}{[\sigma](\lambda x.M)}{A \arrow B}$ \hfill since $\Gamma'' \ext{\rho} \Gamma'$ and $\Gamma'' \vdash N : A$  was arbitrary

\end{proof}


\begin{corollary}
If $\Gamma \vdash M : A$ then $\Gamma \vdash M : A \in \SN$.
\end{corollary}

\begin{proof}
Using the fundamental lemma with the identity substitution $\inden{\Gamma}{\textsf{id}}{\Gamma}$, we obtain  $\inden{\Gamma}{M}{A}$. By $\CR 1$, we know $\Gamma \vdash M \in \SN$.
\end{proof}


\newpage

\section{Extension: Unit type}
\label{sec:unit}
We will now extend our simply-typed lambda-calculus the unit type, written as $\one$.

\[
\begin{array}{llcl}
\mbox{Types}  & A & \bnfas & \ldots \mid \one\\
\mbox{Terms}  & M & \bnfas & \ldots \mid ()
\end{array}
\]

In particular, we extend our type-directed reduction rules and allow any term $M$ of type $\one$ to be reduced to $()$.

\[
  \begin{array}{c}
\ianc{M \not= ()}{\Gamma \vdash M \red () : \one}    {}
  \end{array}
\]

We extend our definition of $\SN$ and $\redSN$ as follows:

\[
  \begin{array}{c}
\ianc{}{\Gamma \vdash () : \one \in \SN}    {} \qquad
\ianc{\Gamma \vdash M : \one}{\Gamma \vdash M \redSN () : \one}{}
  \end{array}
\]

We omit here the extensions in the proofs about $\SN$, in particular the renaming, anti-renaming and substitution lemmas.

As $\one$ is simply a new base type, we simply say

\begin{center}
\begin{tabular}{lcl}
$\inden{\Gamma}{M}{\one}$ & iff & $\Gamma \vdash M : \one \in \SN$
\end{tabular}
\end{center}

We revisit our previous theorem \ref{thm:redcand} and highlight the cases for unit.

\begin{theorem*}
\CR 1: If $\inden{\Gamma}{M}{A}$ then $\Gamma \vdash M : A \in \SN$. % , i.e. $\den{A} \subseteq \SN$.%
\end{theorem*}

\begin{proof}
Induction on type $A$.

\paragraph{Case} $A = \one$.
\\[1em]
$\Gamma \vdash M : \one \in \SN$ \hfill by def. of $\inden{\Gamma}{M}{A}$

\end{proof}

\begin{theorem*}
\CR 2: If $\Gamma \vdash M : A \in \SNe$ then $\inden{\Gamma}{M}{A}$. % , i.e. $\SNe \subseteq \den{A}$. %
\end{theorem*}
\begin{proof}
Induction on $A$.

\paragraph{Case} $A = \one$.
\\[1em]
$\Gamma \vdash M : \one \in \SNe$ \hfill by assumption \\
$\Gamma \vdash M : \one \in \SN$ \hfill by def. of $\SN$\\
$\inden \Gamma M \one$ \hfill by def. of semantic interpretation of $\one$

\end{proof}


\begin{theorem*}
 \CR 3: If $\Gamma \vdash M \redSN M' : A$ and $\inden{\Gamma}{M'}{A}$ then $\inden{\Gamma}{M}{A}$, i.e. backwards closure.
\end{theorem*}
\begin{proof}
Induction on $A$.

\paragraph{Case} $A = \one$
\\[1em]
$\Gamma \vdash M' : \one \in \SN$ \hfill by assumption $\inden{\Gamma}{M'}{\one}$ \\
$\Gamma \vdash M \redSN M' : \one$ \hfill by assumption
$\Gamma \vdash M : \one \in \SN$ \hfill by def. of $\SN$

\end{proof}

We can now revisit the fundamental lemma.

 \begin{lemma}[Fundamental lemma]
 If $\Gamma \vdash M : C$ and $\inden{\Gamma'}{\sigma}{\Gamma}$
 then $\inden{\Gamma'}{[\sigma]M}{C}$.
 \end{lemma}
 \begin{proof}
 By induction on $\Gamma \vdash M : C$.

\paragraph{Case} $\D = \ianc{}{\Gamma \vdash () : \one}{}$
\\[1em]
$\Gamma \vdash () : \one \in \SN$ \hfill by def. of $\SN$\\
$\inden \Gamma {()} \one$ \hfill by def. of $\mathcal{R}_\one$\\

\end{proof}

\newpage

\renewcommand{\inl}{\textsf{inl}\;}
\renewcommand{\inr}{\textsf{inr}\;}
\newcommand{\caseof}[3]{\textsf{case}\,#1\,\textsf{of inl}\,x \Rightarrow #2 \mid \textsf{inr}\,y \Rightarrow #3}


\section{Extension: Disjoint sums}

We will now extend our simply-typed lambda-calculus to disjoint sums.

\[
\begin{array}{llcl}
\mbox{Types}  & A & \bnfas & \ldots \mid A + B\\
\mbox{Terms}  & M & \bnfas & \ldots \mid \inl M \mid \inr M \mid \caseof{M}{N_1}{N_2}
\end{array}
\]

Let us first extend our definition of $\SN$ and $\SNe$ (see Fig.~\ref{fig:sncase}).

\begin{figure}
 \centering

\[
\begin{array}{c}
\multicolumn{1}{l}{\mbox{Neutral terms}} \\% [0.5em]
\infer{\Gamma \vdash \caseof{M}{N_1}{N_2} : C \in \SNe}{\Gamma \vdash M : A + B \in \SNe & \Gamma, x{:}A \vdash N_1 : C \in \SN & \Gamma, y{:}B \vdash N_2 : C\in \SN}
\\% [0.5em]
%
\multicolumn{1}{l}{\mbox{Normal terms}} \\% [0.5em]
\infer{\Gamma \vdash \inl M : A + B \in \SN}{\Gamma \vdash M : A \in \SN} \qquad \infer{\Gamma \vdash \inr M : A + B \in \SN}{\Gamma \vdash M : B \in \SN}
\\% [0.5em]
\multicolumn{1}{l}{\mbox{Strong head reduction}} \\[1em]
\infer{\Gamma \vdash \caseof{(\inl M)}{N_1}{N_2} \redSN [M/x]N_1 : C}{\Gamma \vdash M : A \in \SN & \Gamma, y{:}B \vdash N_2 : C \in \SN}
\\[0.75em]
\infer{\Gamma \vdash \caseof{(\inr M)}{N_1}{N_2} \redSN [M/x]N_2 : C}{\Gamma \vdash M : B \in \SN & \Gamma, x{:}A \vdash N_1 : C \in \SN}
\\[0.75em]
\infer{\Gamma \vdash \caseof{M}{N_1}{N_2} \redSN \caseof{M'}{N_1}{N_2} : C}{\Gamma \vdash M \redSN M' : A + B}
\end{array}
\]

   \caption{Inductive definition of strongly normalizing terms - extended for case-expressions and injections}
   \label{fig:sncase}
 \end{figure}


Next, we extend our definition of semantic type to disjoint sums. A first attempt might be to define $\denot{A + B}$ as follows:

\paragraph{Attempt 1}
\begin{alignat*}{3}
\inden{\Gamma}{M}{A + B} ~\text{iff} &&M = \inl M' &~\text{and}~ \inden{\Gamma}{M'}{A}, \\
& ~~\emph{or}~ &M = \inr M' &~\text{and}~ \inden{\Gamma}{M'}{B}.
% \den{A+B} := \{\inl M \mid M \in \den{A} \} \cup \{\inr M \mid M \in \den{B} \}
\end{alignat*}

However, this definition would not satisfy the key property $\CR3$ and hence would fail to be a reducibility candidate. For example,  while we have $\inden{y : A}{\inl y}{A + B}$, it is not the case that $\inden{y : A}{(\lambda x. \inl x)\;y}{A + B}$, despite the fact that $(\lambda x. \inl x)\;y \redSN \inl y$.
\\[1em]
Our definition of $\denot{A + B}$ is not closed under the reduction relation $\redSN$. Let $\A$ denote the denotation of $\denot{A}$. We then define the closure of $\denot{A} = \A$, written as  $\clos\A$, inductively as follows:

%\[
%\begin{array}{c}
%\ianc{M \in \A}{M\in \clos\A}{}  \qquad
%\ianc{M \in \SNe}{M \in \clos\A}{} \qquad
%\ibnc{M \in \clos\A}{N \redSN M}{N \in \clos\A}{}
%\end{array}
%\]

\[
\begin{array}{c}
\ianc{\Gamma \vdash M \in \A}{\Gamma \vdash M \in \clos\A}{} \qquad
\ianc{\Gamma \vdash M : A \in \SNe}{\Gamma \vdash M \in \clos\A}{} \qquad
\ibnc{\Gamma \vdash M : \clos\A}{\Gamma \vdash N \redSN M : A}{\Gamma \vdash N : \clos\A}{}
\end{array}
\]

and we define

\[
\begin{array}{lcl}
\inden{\Gamma}{M}{A + B} & \text{iff} & \Gamma \vdash M \in \clos{ \{\inl M' \mid \inden{\Gamma}{M'}{A} \} \cup \{\inr M' \mid \inden{\Gamma}{M'}{B} \}  }
\end{array}
\]

\subsection{Semantic type $\denot{A + B}$ is a reducibility candidate}
We first extend our previous theorem which states that all denotations of types must be in $\CR$.

\begin{theorem}
For all types $C$, $\denot{C}  \in \CR$.
\end{theorem}
\begin{proof}
By induction on the structure of $C$. We highlight the case for disjoint sums.

\paragraph{Case $C = A + B$.}

  \begin{enumerate}
  \item \textit{Show} $\CR1$. Assume that $\inden{\Gamma}{M}{A + B}$. We consider different subcases and prove by an induction on the closure defining $\denot{A + B}$ that $\Gamma \vdash M : A + B \in \SN$.

\paragraph{Subcase:} $\Gamma \vdash M \in \{\inl N \mid \inden{\Gamma}{N}{A}\}$. Therefore $M = \inl N$. Since $\inden{\Gamma}{N}{A}$ and by i.h. ($\CR1$), $\Gamma \vdash N : A \in \SN$. By definition of $\SN$, we have that $\Gamma \vdash \inl N : A + B \in \SN$.

\paragraph{Subcase:} $\Gamma \vdash M \in \{\inr N \mid \inden{\Gamma}{N}{B}\}$. Therefore $M = \inr N$. Since $\inden{\Gamma}{N}{B}$ and by i.h. ($\CR1$), $\Gamma \vdash N : B \in \SN$. By definition of $\SN$, we have that $\Gamma \vdash \inr N : A + B \in \SN$.

\paragraph{Subcase:} $\Gamma \vdash M : A + B \in \SNe$. By definition of $\SN$, we conclude that $\Gamma \vdash M : A + B \in \SN$.

\paragraph{Subcase:} $\Gamma \vdash M \redSN M' : A + B$ and $\inden{\Gamma}{M'}{A+B}$.
\\[0.5em]
$\Gamma \vdash M \redSN M' : A + B$ and $\inden{\Gamma}{M'}{A + B}$ \hfill by assumption\\
$\Gamma \vdash M' : A + B \in \SN$ \hfill by inner i.h. \\
$\Gamma \vdash M : A + B \in \SN$ \hfill by reduction $\redSN$

 \item \textit{Show} $\CR2$. If $\Gamma \vdash M : A + B \in \SNe$, then $\inden{\Gamma}{M}{A + B}$. \\
By definition of the closure, if $\Gamma \vdash M : A + B \in \SNe$, we have $\inden{\Gamma}{M}{A + B}$.


  \item \textit{Show} $\CR3$. If $\Gamma \vdash M \redSN M' : A + B$ and $\inden{\Gamma}{M'}{A+B}$
    then $\inden{\Gamma}{M}{A+B}$.\\
By definition of the closure, if $\Gamma \vdash M \redSN M' : A + B$ and $\inden{\Gamma}{M'}{A+B}$, we have
$\inden{\Gamma}{M}{A+B}$.
\end{enumerate}

\end{proof}


 \subsection{Revisiting the fundamental lemma}

 We can now revisit the fundamental lemma.

 \begin{lemma}[Fundamental lemma]
 If $\Gamma \vdash M : C$ and $\inden{\Gamma'}{\sigma}{\Gamma}$
 then $\inden{\Gamma'}{[\sigma]M}{C}$.
 \end{lemma}
 \begin{proof}
 By induction on $\Gamma \vdash M : C$.

 \paragraph{Case} $\D = \ianc{\Gamma \vdash M \hastype A}{\Gamma \vdash \inl M \hastype A + B}{}$
 \\[1em]
 $\inden{\Gamma'}{\sigma}{\Gamma}$ \hfill by assumption \\
 $\inden{\Gamma'}{[\sigma]M}{A}$ \hfill by i.h. \\
 $\inden{\Gamma'}{\inl [\sigma]M}{A + B}$ \hfill by definition of $\denot{A + B}$ \\
 $\inden{\Gamma'}{[\sigma] \inl M}{A + B}$ \hfill by subst. definition

 \paragraph{Case} $\D = \ianc{\Gamma \vdash M \hastype B}{\Gamma \vdash \inr M \hastype A + B}{}$
 \\[1em]
 similar to the case above.

 \paragraph{Case} $\D = \icnc{\Gamma \vdash M : A + B}{\Gamma, x{:}A \vdash M_1 :  C}{\Gamma, y{:}B \vdash M_2 : C}
 {\Gamma \vdash \caseof{M}{M_1}{M_2} : C}{}$
 \\[1em]
 $\inden{\Gamma'}{\sigma}{\Gamma}$ \hfill by assumption \\
 $\inden{\Gamma'}{[\sigma]M}{A + B}$ \hfill by i.h.
 \\[1em]
 We consider different subcases and prove by induction on the closure defining $\denot{A + B}$, that $\inden{\Gamma'}{[\sigma](\caseof{M}{M_1}{M_2})}{C}$.

\paragraph{Subcase $\Gamma' \vdash [\sigma]M \in \{\inl N \mid \inden{\Gamma'}{N}{A}\}$}$\;$\\[1em]
$[\sigma]M = \inl N$ for some $\inden{\Gamma'}{N}{A}$ \hfill by assumption \\
$\Gamma' \vdash N : A \in \SN$ \hfill by $\CR1$ \\
$\Gamma' \vdash \inl N : A + B \in \SN$ \hfill by definition \\
% $x \in \den{A}$,
$\inden{\Gamma'}{\sigma}{\Gamma}$ \hfill by assumption \\
$\inden{\Gamma'}{[\sigma, N/x]}{\Gamma, x:A}$ \hfill by definition \\
$\inden{\Gamma'}{[\sigma, N/x]M_1}{C}$ \hfill by outer i.h \\
$\inden{\Gamma', y{:}B}{y}{B}$  \hfill by definition \\
$\inden{\Gamma', y{:}B}{[\sigma, y/y]}{\Gamma, y:B}$ \hfill by definition \\
$\inden{\Gamma', y{:}B}{[\sigma, y/y]M_2}{C}$ \hfill by outer i.h. \\
$\Gamma', y{:}B \vdash [\sigma, y/y]M_2 : C \in \SN$ \hfill by $\CR1$ \\
$\Gamma' \vdash \caseof{(\inl N)}{[\sigma,x/x]M_1}{[\sigma, y/y]M_2} \redSN [\sigma, N/x]M_1 : C$ \hfill by $\redSN$\\
$\caseof{(\inl N)}{[\sigma,x/x]M_1}{[\sigma, y/y]M_2}$ \\
$\qquad = [\sigma](\caseof{M}{M_1}{M_2}) $ \hfill by subst. definition and $[\sigma]M = \inl N$\\
$\inden{\Gamma'}{[\sigma](\caseof{M}{M_1}{M_2})}{C}$ \hfill by $\CR3$

\paragraph{Subcase $\Gamma' \vdash [\sigma]M \in \{\inr N \mid \inden{\Gamma'}{N}{B}\}$}$\;$\\[1em]
similar to the case above.

\paragraph{Subcase: $\Gamma' \vdash [\sigma]M : A + B \in \SNe$}.$\;$\\
$\inden{\Gamma'}{\sigma}{\Gamma}$ \hfill by assumption \\
$\inden{\Gamma', x{:}A}{x}{A}$ \hfill by definition \\
$\inden{\Gamma', y{:}B}{y}{B}$  \hfill by definition \\
$\inden{\Gamma', x{:}A}{[\sigma, x/x]}{\Gamma, x:A}$ \hfill by definition \\
$\inden{\Gamma', y{:}B}{[\sigma, y/y]}{\Gamma, y:B}$ \hfill by definition \\
$\inden{\Gamma', x{:}A}{[\sigma, x/x]M_1}{C}$ \hfill by outer i.h. \\
$\inden{\Gamma', y{:}B}{[\sigma, y/y]M_2}{C}$ \hfill by outer i.h. \\
$\Gamma', x{:}A \vdash [\sigma, x/x]M_1 : C \in \SN$ \hfill by $\CR1$ \\
$\Gamma', y{:}B \vdash [\sigma, y/y]M_2 : C \in \SN$ \hfill by $\CR1$ \\
$\Gamma' \vdash \caseof{[\sigma]M}{[\sigma, x/x]M_1}{[\sigma, y/y]M_2} : C \in \SNe$ \hfill by $\SNe$ \\
$\Gamma' \vdash [\sigma](\caseof{M}{M_1}{M_2}) : C \in \SNe$ \hfill by substitution def. \\
$\inden{\Gamma'}{[\sigma](\caseof{M}{M_1}{M_2})}{C}$ \hfill by $\CR2$


\paragraph{Subcase: $\Gamma' \vdash [\sigma]M \redSN M' : A + B$ and $\inden{\Gamma'}{M'}{A+B}$}$\;$\\
$\Gamma' \vdash [\sigma]M \redSN M' : A + B$ and $\inden{\Gamma'}{M'}{A+B}$ \hfill by assumption \\
$\inden{\Gamma'}{\caseof{M'}{[\sigma,x/x]M_1}{[\sigma,y/y]M_2}}{C}$ \hfill by inner i.h. \\
$\Gamma' \vdash \caseof{[\sigma]M}{[\sigma,x/x]M_1}{[\sigma,y/y]M_2} $ \\
$\qquad \qquad\redSN
\caseof{M'}{[\sigma,x/x]M_1}{[\sigma,y/y]M_2} : C$ \hfill by $\redSN$\\
$\inden{\Gamma'}{[\sigma](\caseof{M}{M_1}{M_2})}{C}$ \hfill by $\CR3$

\end{proof}


 \section{Extension: Recursion}
 \newcommand{\zero}{\mathsf{z}}
 % \renewcommand{\suc}{\textsf{s}\;}
 % \newcommand{\recnat}[3]{\textsf{rec} (#1,\,#2,\; #3)}
 \newcommand{\recnat}[3]{\recmatch{}{#1}{#2}{#3}}
 % \renewcommand{\nat}{\textsf{Nat}}
 We now extend our simply-typed lambda-calculus to include natural numbers
 defined by $\zero$ and $\suc t$ as well as a primitive recursion operator
 written as $\recnat{M}{M_z}{M_s}$ where $M$ is the argument we recurse over,
 $M_z$ describes the branch taken if $M = \zero$ and $M_s$ describes the branch
 taken when $M = \suc N$ where $n$ will be instantiated with $N$ and $f\;n$
 describes the recursive call.


\[
\begin{array}{llcl}
\mbox{Types}  & A & \bnfas & \ldots \mid \nat \\
\mbox{Terms}  & t & \bnfas & \ldots \mid \zero \mid \suc t \mid \recnat{t}{t_z}{t_s}
\end{array}
\]

To clarify, we give the typing rules for the additional constructs.

\[
\begin{array}{c}
\infer{\Gamma \vdash \zero : \nat}{} \qquad
\infer{\Gamma \vdash \suc M : \nat}{\Gamma \vdash M : \nat}
\\[1em]
\infer{\Gamma \vdash \recnat M {M_z} {M_s} : C}{
\Gamma \vdash M : \nat & \Gamma \vdash M_z : C &
\Gamma, n:\nat,\;f\,n:C \vdash M_s : C}
\end{array}
\]


We again extend our definition of $\SN$ and $\SNe$.

\[
\begin{array}{c}
\multicolumn{1}{l}{\mbox{Neutral terms}} \\[1em]
\infer{\Gamma \vdash \recnat{M}{M_z}{M_s} : C \in \SNe}{\Gamma \vdash M : \nat \in \SNe & \Gamma \vdash M_z : C \in \SN & \Gamma, n \hastype \nat, f~n \hastype C \vdash M_s : C \in \SN}\\[1em]
\multicolumn{1}{l}{\mbox{Normal terms}} \\[1em]
\infer{\Gamma \vdash \zero : \nat \in \SN}{} \qquad \infer{\Gamma \vdash \suc M : \nat \in \SN}{\Gamma \vdash M : \nat \in \SN}\\[1em]
\multicolumn{1}{l}{\mbox{Strong head reduction}} \\[1em]
\infer{\Gamma \vdash \recnat{\zero}{M_z}{M_s} \redSN M_z : C}{\Gamma, n \hastype \nat, f~n \hastype C \vdash M_s : C \in SN} \\[1em]
\infer{\recnat{(\suc N)}{M_z}{M_s} \redSN [N/n,\, f_r/f\,n]M_s : C}{
  \Gamma \vdash N : \nat \in \SN & \Gamma \vdash M_z : C \in \SN & \Gamma, n \hastype \nat, f~n \hastype C \vdash M_s : C \in SN & f_r = \recnat{N}{M_z}{M_s}} \\[1em]
\infer{\Gamma \vdash \recnat{M}{M_z}{M_s} \redSN \recnat{M'}{M_z}{M_s} : C}{\Gamma \vdash M \redSN M' : \nat}
\end{array}
\]

 \section{Extension: Natural numbers}
Here we add natural numbers to our language and show how the language remains normalizing.
\subsection{Semantic type $\denot{\nat}$} We define the denotation of $\nat$ as
 follows:

% \[
% \den{\nat} := \clos{\{\zero\}\cup \{\suc M \mid M \in \den{\nat}\} }
% \]

	\[
	\begin{array}{lcl}
	\inden{\Gamma}{M}{\nat} & \text{iff} & \Gamma \vdash M \in \clos{ \{\zero\}\cup \{\suc M' \mid \inden{\Gamma}{M'}{\nat}\} }
	\end{array}
	\]


\subsection{Semantic type $\denot{\nat}$ is a reducibility candidate}
We again extend our previous theorem which states that all denotations of types must be in $\CR$.

\begin{theorem}
For all types $C$, $\denot{C}  \in \CR$.
\end{theorem}
\begin{proof}
By induction on the structure of $C$. We highlight the case for $\nat$.

\paragraph{Case $C = \nat$.}

\begin{enumerate}
\item \textit{Show} $\CR1$. Assume $\inden{\Gamma}{M}{\nat}$. We consider different subcases
  and prove by induction on the closure defining $\denot{\nat}$ that $\Gamma \vdash M : \nat \in \SN$.
%

\paragraph{Subcase:} $M = \zero$. By definition of $\SN$, $\Gamma \vdash \zero : \nat \in \SN$.

\paragraph{Subcase:} $M = \suc N$ where $\inden{\Gamma}{N}{\nat}$.  By i.h. ($\CR1$),
$\Gamma \vdash N : \nat \in \SN$. By definition of $\SN$, $\Gamma \vdash \suc N : \nat \in \SN$.

 \paragraph{Subcase:} $\Gamma \vdash M  : \nat \in \SNe$. By definition of $\SN$, $\Gamma \vdash M : \nat \in \SN$.

 \paragraph{Subcase:} $\Gamma \vdash M \redSN M' : \nat$ and $\inden{\Gamma}{M'}{\nat}$.
 \\
 $\Gamma \vdash M \redSN M' : \nat$ and $\inden{\Gamma}{M'}{\nat}$ \hfill by assumption \\
 $\Gamma \vdash M' : \nat \in \SN$ \hfill by inner i.h. \\
 $\Gamma \vdash M  : \nat \in \SN$ \hfill by reduction $\redSN$


 \item \textit{Show} $\CR2$. If $\Gamma \vdash M : \nat \in \SNe$, then $\inden{\Gamma}{M}{\nat}.$ \\
	 By definition of the closure, if $\Gamma \vdash M : \nat \in \SNe$, then $\inden{\Gamma}{M}{\nat}$.

 \item \textit{Show} If $\Gamma \vdash M \redSN M' : \nat$ and $\inden{\Gamma}{M'}{\nat}$, then $\inden{\Gamma}{M}{\nat}$. \\
   By definition of the closure, if $\Gamma \vdash M \redSN M' : \nat$ and $\inden{\Gamma}{M'}{\nat}$, we have $\inden{\Gamma}{M}{\nat}$.
 \end{enumerate}
\end{proof}

 \subsection{Revisiting the fundamental lemma}

 We can now revisit the fundamental lemma.
 \begin{lemma}[Fundamental lemma]
 If $\Gamma \vdash M : C$ and $\inden{\Gamma'}{\sigma}{\Gamma}$
 then $\inden{\Gamma'}{[\sigma]M}{C}$.
 \end{lemma}
 \begin{proof}
 By induction on $\Gamma \vdash M : C$.

 \paragraph{Case} $\D = \ianc{}{\Gamma \vdash \zero : \nat}{}$
 \\
 $[\sigma]\zero = \zero$ \hfill by subst. def \\
 $\inden{\Gamma'}{\zero}{\nat}$ \hfill by definition.


 \paragraph{Case} $\D = \ianc{\Gamma \vdash M : \nat}{\Gamma \vdash \suc M :  \nat}{}$
 \\
 $\inden{\Gamma'}{\sigma}{\Gamma}$ \hfill by assumption \\
 $\inden{\Gamma'}{[\sigma]M}{\nat}$ \hfill by i.h. \\
 $\inden{\Gamma'}{\suc [\sigma]M}{\nat}$ \hfill by definition \\
 $\inden{\Gamma'}{[\sigma] \suc M}{\nat}$ \hfill by subst. def


 \paragraph{Case} $\D = \icnc
 {\Gamma \vdash M : \nat}
 {\Gamma \vdash M_z : C}
 {\Gamma, n:\nat,\,f~n:C \vdash M_s : C}
 {\Gamma \vdash \recnat M {M_z} {M_s} : C}{}$
 \\
 $\inden{\Gamma'}{\sigma}{\Gamma}$ \hfill by assumption \\
 $\inden{\Gamma'}{[\sigma]M}{\nat}$ \hfill by i.h. \\[1em]
 We distinguish cases based on $\inden{\Gamma'}{[\sigma]M}{\nat}$ and prove by induction on $\inden{\Gamma'}{[\sigma]M}{\nat}$ that $\inden{\Gamma'}{[\sigma](\recnat M {M_z} {M_s})}{C}$.

 \paragraph{Subcase } $[\sigma]M = \zero$.
 \\
 $\inden{\Gamma', n \hastype \nat, f~n \hastype C}{n}{\nat}$ \hfill by definition of $\SNe$, $\denot{\nat}$ \\
 $\inden{\Gamma', n \hastype \nat, f~n \hastype C}{f~n}{C}$ \hfill by definition of $\SNe$, $\denot{\nat}$ \\
 $\inden{\Gamma', n \hastype \nat, f~n \hastype C}{[\sigma, n/n, f~n/f~n]}{\Gamma, n:\nat, f~n:C}$ \hfill by definition \\
 $\inden{\Gamma', n \hastype \nat, f~n \hastype C}{[\sigma, n/n, f~n/f~n]M_s}{C}$ \hfill by outer i.h. \\
 $\Gamma', n \hastype \nat, f~n \hastype C \vdash [\sigma, n/n, f~n/f~n]M_s : C \in \SN$ \hfill by $\CR1$ \\
 $\inden{\Gamma'}{[\sigma]M_z}{C}$ \hfill by outer i.h. \\
 $\Gamma' \vdash \recnat \zero {[\sigma]M_z} {[\sigma, n/n,f~n/f~n]M_s} \redSN [\sigma]M_z : C$
 \hfill by $\redSN$ \\
 $\recnat \zero {[\sigma]M_z} {[\sigma, n/n,f~n/f~n]M_s}$ \\
 $\qquad = [\sigma](\recnat{M}
 {M_z} {M_s})$ \hfill by subst. def. and $[\sigma]M = \zero$\\
 $\inden{\Gamma'}{[\sigma](\recnat{M} {M_z}{M_s}}{C}$ \hfill by $\CR3$.

 \paragraph{Subcase } $[\sigma]M = \suc M'$ where $\inden{\Gamma'}{M'}{\nat}$.
 \\
 $\inden{\Gamma'}{M'}{\nat}$ \hfill by assumption \\
 $\Gamma \vdash M' : \nat \in \SN$ \hfill by $\CR1$ \\
 $\inden{\Gamma'}{[\sigma]M_z}{C}$ \hfill by outer i.h. \\
 $\Gamma' \vdash [\sigma]M_z \in \SN$ \hfill by $\CR1$ \\
 $\inden{\Gamma', n \hastype \nat, f~n \hastype C}{[\sigma, n/n, f~n/f~n]}{\Gamma, n:\nat, f~n:C}$ \hfill by definition \\
 $\inden{\Gamma', n \hastype \nat, f~n \hastype C}{[\sigma, n/n, f~n/f~n]M_s}{C}$ \hfill by outer i.h. \\
 $\Gamma', n \hastype \nat, f~n \hastype C \vdash [\sigma, n/n, f~n/f~n]M_s : C \in \SN$ \hfill by $\CR1$ \\
 $\inden{\Gamma'}{\recnat{M'}{[\sigma]M_z}{[\sigma, n/n, f~n/f~n]M_s}}{C}$ \hfill by inner i.h. \\
 $\inden{\Gamma'}{[\sigma, M'/n, (\recnat{M'}{[\sigma]M_z}{[\sigma, n/n, f~n/f~n]M_s})/f~n]}{\Gamma, n:\nat, f~n:C}$ \\
 $~$ \hfill by definition \\
 $\inden{\Gamma'}{[\sigma, M'/n, (\recnat{M'}{[\sigma]M_z}{[\sigma, n/n, f~n/f~n]M_s})/f~n]M_s}{C}$ \\
 $~$ \hfill by outer i.h. \\
 $\Gamma' \vdash \recnat{(\suc M')}{[\sigma]M_z}{[\sigma, n/n, f~n/f~n]M_s} $ \\
 $\qquad \qquad \redSN
 [\sigma, M'/n, (\recnat{M'}{[\sigma]M_z}{[\sigma, n/n, f~n/f~n]M_s})/f~n]M_s : C$ \\
 $~$ \hfill by $\redSN$ \\
 $\inden{\Gamma'}{[\sigma](\recnat{M}{M_z}{M_s})}{C}$ \hfill by $\CR3$.

 \paragraph{Subcase } $\Gamma' \vdash [\sigma]M : \nat \in \SNe$. \\
 $\inden{\Gamma'}{[\sigma]M_z}{C}$ \hfill by outer i.h.\\
 $\Gamma' \vdash [\sigma]M_z : C \in \SN$ \hfill by $\CR1$\\
 $\inden{\Gamma', n \hastype \nat, f~n \hastype C}{[\sigma, n/n, f~n/f~n]}{\Gamma, n:\nat, f~n:C}$ \hfill by definition \\
 $\inden{\Gamma', n \hastype \nat, f~n \hastype C}{[\sigma, n/n, f~n/f~n]M_s}{C}$ \hfill by outer i.h. \\
 $\Gamma', n \hastype \nat, f~n \hastype C \vdash [\sigma, n/n, f~n/f~n]M_s : C\in \SN$ \hfill by $\CR1$ \\
 $\Gamma \vdash \recnat{[\sigma]M}{[\sigma]M_z}{[\sigma, n/n, f~n/f~n]M_s} : C \in \SNe$ \hfill by $\SNe$\\
 $\Gamma' \vdash [\sigma](\recnat{M}{M_z}{M_s}) : C \in \SNe$ \hfill by subst. def. \\
 $\inden{\Gamma'}{[\sigma](\recnat{M}{M_z}{M_s})}{C}$ \hfill by $\CR2$.


 \paragraph{Subcase } $\Gamma' \vdash [\sigma]M \redSN M' : \nat$ and $\inden{\Gamma'}{M'}{\nat}$.\\
 $\Gamma' \vdash [\sigma]M \redSN M' : \nat$ and $\inden{\Gamma'}{M'}{\nat}$ \hfill by assumption.\\
 $\inden{\Gamma'}{\recnat{M'}{[\sigma]M_z}{[\sigma,n/n, f~n/f~n]M_s}}{C}$ \hfill by inner i.h. \\
 $\Gamma' \vdash \recnat{[\sigma]M}{[\sigma]M_z}{[\sigma,n/n, f~n/f~n]M_s}$ \\
 $\qquad \qquad \redSN \recnat{M'}{[\sigma]M_z}{[\sigma,n/n, f~n/f~n]M_s} : C$ \hfill by $\redSN$\\
 $\inden{\Gamma'}{[\sigma](\recnat{M}{M_z}{M_s})}{C}$ \hfill by $\CR3$.


 \end{proof}


%  \section{Exercises}
%  \begin{problem}
% % \begin{exercise}
%  The Def. \ref{def:norm}, defines strong normalization informally. We can replace this definition with a more formal definition.

%  \begin{definition}[Inductive definition of strongly normalizing terms] A term $M$ is strongly normalizing, if all its reducts are strongly normalizing, i.e.
%  $M \csn$ if for all $M'$, if $M \red M'$ then $M' \in \csn$.
%  \end{definition}

%  This definition gives rise to an induction principle to reason about strongly normalizing terms. To prove $\forall M \csn. P(M)$, we can assume the property holds for $P(M')$ for any $M'$ s.t. $M \red M'$. Using this induction principle, we can now prove  constructively that any subterm of a strongly normalizing term is itself normalizing.

%  Before we however, precisely define our notion of subterm to simplify our reasoning. We write $M = C[N]$ for $N$ is a subterm of $M$; $C$ denotes an evaluation context, i.e. the term $M$ where we identify $N$ as a subterm at a given position. Evaluation contexts can  be defined as follows.

%  \[
%  \begin{array}{lcl}
%  \mbox{Evaluation Context}\;C & \bnfas & [ ] \mid \lambda x. C \mid C\;N \mid M\;C
%  \end{array}
%  \]

%  As an alternative to the congruence rules, we can redefine evaluation using evaluation contexts:

%  \[
%  \ianc{M \red N}{C[M] \red C[N]}{}
%  \]

% \begin{theorem}
% Any subterm of a strongly normalizing term is strongly normalizing itself, i.e. if $M \csn$ and $N$ is a subterm of $M$, i.e. $M = C[N]$ then $N \in \csn$.
% \end{theorem}
% \end{exercise}
% \end{problem}



% \begin{problem}
%   \begin{exercise}
% Extend the semantic strong normalization proof to treat $A \times B$.
% \begin{itemize}
% \item Extend our definition of normal and neutral terms (i.e. $\SN$ and $\SNe$). You might also need to extend our definition of strong head reduction (i.e. $\redSN$).
% \item Define an appropriate denotation of $\den{A \times B}$.
% % \den{A * B} := {M | \fst(M) \in \den{A} or \snd{M} \in \den{B}}
% \item Show that $\den{A \times B}$ is a reducibility candidate.
% \item Show the additional cases in the fundamental lemma.
% \end{itemize}
%   \end{exercise}
% \end{problem}


%\section{Reducibility candidates}
%\section{Forward and backward closed}
%\section{Fundamental lemma}

\bibliographystyle{plainnat}
% \bibliography{../../bibliography/bibi,../../bibliography/bp}
\bibliography{bibi-extract}

\end{document}
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "sn-proof"
%%% End:

%  LocalWords:  Girard Tait llcl lcl redex subterms iff reducts IH
%  LocalWords:  subst subterm todo Girard's instantiation inl inr
%  LocalWords:  subcases Subcase
